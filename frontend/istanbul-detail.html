<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Ä°stanbul DetaylÄ± Analiz â€” Greygreen</title>
<link rel="icon" type="image/png" href="../images/favicon.png"/>
<!-- CSS -->
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/istanbul-detail.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<!-- Top Bar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="sidebar-toggle" id="sidebar-toggle" title="Sidebar AÃ§/Kapat">â˜°</button>
    <div class="topbar-brand" onclick="location.href='/dashboard.html'">ğŸŒ Grey vs Green Atlas</div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn">ğŸ”” <span>3</span></button>
    <div class="topbar-user">
      <span>ğŸ‘¤</span>
      <span id="who">YÃ¼kleniyor...</span>
    </div>
    <button class="topbar-logout" id="logout">
      <span>ğŸšª</span>
      <span>Ã‡Ä±kÄ±ÅŸ</span>
    </button>
  </div>
</header>

<!-- Layout with Sidebar -->
<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-resizer" id="sidebar-resizer"></div>

    <!-- Ana MenÃ¼ -->
    <div class="sidebar-section">
      <div class="sidebar-title">Ana MenÃ¼</div>
      <nav class="nav">
        <a href="/dashboard.html">
          <span>ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/map.html">
          <span>ğŸ—ºï¸</span>
          <span>Harita</span>
        </a>
        <a href="/istanbul-detail.html" class="active">
          <span>ğŸ”¬</span>
          <span>Ä°stanbul Detay</span>
        </a>
      </nav>
    </div>

    <!-- Veri YÃ¶netimi -->
    <div class="sidebar-section">
      <div class="sidebar-title">Veri YÃ¶netimi</div>
      <nav class="nav">
        <a href="/data-sources.html">
          <span>ğŸ›°ï¸</span>
          <span>Veri KaynaklarÄ±</span>
        </a>
        <a href="/data-upload.html">
          <span>ğŸ“¤</span>
          <span>Veri Setleri</span>
        </a>
        <a href="/reports.html">
          <span>ğŸ§¾</span>
          <span>Raporlar</span>
        </a>
      </nav>
    </div>

    <!-- Sistem -->
    <div class="sidebar-section">
      <div class="sidebar-title">Sistem</div>
      <nav class="nav">
        <a href="/settings.html">
          <span>âš™ï¸</span>
          <span>Ayarlar</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content with 2-Column Layout -->
  <main class="main">
    <!-- Floating Toggle Buttons -->
    <button class="detail-toggle-float detail-toggle-left" id="detail-toggle-left">â—€</button>
    <button class="detail-toggle-float detail-toggle-right" id="detail-toggle-right">â–¶</button>
    <button class="detail-toggle-float detail-toggle-bottom" id="detail-toggle-bottom">â–²</button>
    
    <div class="detail-container">
  <!-- Left Sidebar - Satellite Controls -->
  <aside class="detail-sidebar detail-sidebar-left" id="detail-sidebar-left">
    <button class="detail-sidebar-toggle detail-sidebar-toggle-left" id="detail-sidebar-toggle-left">âœ•</button>
    
    <!-- Uydu GÃ¶rÃ¼ntÃ¼sÃ¼ -->
    <div class="section">
      <div class="section-title">âš™ï¸ Uydu GÃ¶rÃ¼ntÃ¼sÃ¼</div>
      <div class="satellite-controls">
        <label class="control-label">Zaman Dilimi</label>
        <select class="satellite-select" id="satellite-time">
          <option value="2018_1" selected>2018 Q1 (Ocak-Mart)</option>
          <option value="2025_4">2025 Q4 (Ekim-AralÄ±k)</option>
          <option value="2025_3">2025 Q3 (Temmuz-EylÃ¼l)</option>
          <option value="2025_2">2025 Q2 (Nisan-Haziran)</option>
          <option value="2025_1">2025 Q1 (Ocak-Mart)</option>
          <option value="2024_4">2024 Q4 (Ekim-AralÄ±k)</option>
          <option value="2024_3">2024 Q3 (Temmuz-EylÃ¼l)</option>
          <option value="2024_2">2024 Q2 (Nisan-Haziran)</option>
          <option value="2024_1">2024 Q1 (Ocak-Mart)</option>
          <option value="2023_4">2023 Q4</option>
          <option value="2023_3">2023 Q3</option>
          <option value="2023_2">2023 Q2</option>
          <option value="2023_1">2023 Q1</option>
          <option value="2022_4">2022 Q4</option>
          <option value="2022_3">2022 Q3</option>
          <option value="2022_2">2022 Q2</option>
          <option value="2022_1">2022 Q1</option>
          <option value="2021_4">2021 Q4</option>
          <option value="2021_3">2021 Q3</option>
          <option value="2021_2">2021 Q2</option>
          <option value="2021_1">2021 Q1</option>
          <option value="2020_4">2020 Q4</option>
          <option value="2020_3">2020 Q3</option>
          <option value="2020_2">2020 Q2</option>
          <option value="2020_1">2020 Q1</option>
          <option value="2019_4">2019 Q4</option>
          <option value="2019_3">2019 Q3</option>
          <option value="2019_2">2019 Q2</option>
          <option value="2019_1">2019 Q1</option>
          <option value="2018_4">2018 Q4</option>
          <option value="2018_3">2018 Q3</option>
          <option value="2018_2">2018 Q2</option>
        </select>
        
        <label class="control-label">Katmanlar</label>
        <div class="layer-buttons">
          <button class="view-btn active" data-index="ndvi">ğŸŒ³ YeÅŸil Alan</button>
          <button class="view-btn" data-index="ndbi">ğŸ¢ Beton/YapÄ±</button>
          <button class="view-btn" data-index="ndwi">ğŸ’§ Su AlanÄ±</button>
          <button class="view-btn" data-index="rgb">ğŸ–¼ï¸ DoÄŸal GÃ¶rÃ¼nÃ¼m</button>
        </div>
        
        <label class="control-label">ÅeffaflÄ±k: <span id="opacity-value">70%</span></label>
        <input type="range" class="opacity-slider" id="tile-opacity" min="0" max="100" value="70">
        
        <div class="satellite-toggle">
          <label>
            <input type="checkbox" id="tile-layer-toggle" checked>
            <span>Uydu katmanÄ±nÄ± gÃ¶ster</span>
          </label>
        </div>
      </div>
    </div>
  </aside>
  
  <!-- Map -->
  <main class="map-container">
    <div id="loading" class="loading">
      <div class="loading-spinner">ğŸ—ºï¸</div>
      <div class="loading-text">DetaylÄ± Analiz YÃ¼kleniyor...</div>
    </div>
    <div id="map"></div>
  </main>
  
  <!-- Right Sidebar - Analysis Panel -->
  <aside class="detail-sidebar detail-sidebar-right" id="detail-sidebar-right">
    <button class="detail-sidebar-toggle detail-sidebar-toggle-right" id="detail-sidebar-toggle-right">âœ•</button>
    
    <!-- GÃ¶rÃ¼nÃ¼m -->
    <div class="section">
      <div class="section-title">ğŸ“Š GÃ¶rÃ¼nÃ¼m</div>
      <div class="view-mode">
        <button class="view-btn active" data-layer="all">ğŸŒˆ TÃ¼m Katmanlar</button>
        <button class="view-btn" data-layer="green">ğŸŒ³ YeÅŸil Alan</button>
      </div>
      <div class="view-mode" style="margin-top:8px">
        <button class="view-btn" data-layer="grey">ğŸ¢ Beton</button>
        <button class="view-btn" data-layer="water">ğŸ’§ Su AlanÄ±</button>
      </div>
    </div>
    
    <!-- Risk BÃ¶lgeleri -->
    <div class="section">
      <div class="section-title">âš ï¸ Risk BÃ¶lgeleri</div>
      <div class="district-list" id="district-list">
        <!-- Dynamically populated -->
      </div>
    </div>
    
    <!-- Ã–zet Bilgiler -->
    <div class="section">
      <div class="section-title">ï¿½ Ã–zet Bilgiler</div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Toplam Alan:</div>
          <div class="info-value" id="total-area">5,461 kmÂ²</div>
        </div>
        <div class="info-item">
          <div class="info-label">NÃ¼fus:</div>
          <div class="info-value" id="population">15,907,951</div>
        </div>
        <div class="info-item">
          <div class="info-label">KiÅŸi BaÅŸÄ± YeÅŸil:</div>
          <div class="info-value" id="green-per-capita">10.70 mÂ²</div>
        </div>
        <div class="info-item">
          <div class="info-label">YÄ±llÄ±k KayÄ±p:</div>
          <div class="info-value danger" id="loss-rate">-1.2%</div>
        </div>
      </div>
    </div>
  </aside>
    </div>
    
    <!-- Bottom Horizontal Bar - Tarihsel Trend -->
    <aside class="bottom-bar" id="bottom-bar">
      <button class="bottom-bar-toggle" id="bottom-bar-toggle">âœ•</button>
      <div class="section-title">ğŸ“ˆ Tarihsel Trend (2018-2025)</div>
      <div class="chart-container-horizontal">
        <canvas id="trendChart" style="display:block;"></canvas>
      </div>
    </aside>
  </main>
</div>

<script>
console.log('ğŸš€ Script starting...');
const token = localStorage.getItem('token');
if(!token){ location.href='/'; }

// Auth
async function whoami(){
  const r = await fetch('/me',{headers:{Authorization:`Bearer ${token}`}});
  if(!r.ok){ localStorage.removeItem('token'); location.href='/'; return; }
  const me = await r.json();
  document.getElementById('who').textContent = me.email;
}
whoami();
document.getElementById('logout').onclick = () => {
  localStorage.removeItem('token'); location.href='/';
};

// Sidebar toggle
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
let isCollapsed = true; // Start collapsed on istanbul-detail page

// Initialize sidebar as collapsed
sidebar.classList.add('collapsed');
sidebarToggle.textContent = 'â˜°';

sidebarToggle.onclick = () => {
  isCollapsed = !isCollapsed;
  sidebar.classList.toggle('collapsed', isCollapsed);
  sidebarToggle.textContent = isCollapsed ? 'â˜°' : 'âœ•';
  
  // Sol ana sidebar aÃ§Ä±ldÄ±ÄŸÄ±nda sol detail sidebar'Ä± kapat
  if (!isCollapsed) {
    const detailSidebarLeft = document.getElementById('detail-sidebar-left');
    if (detailSidebarLeft && !detailSidebarLeft.classList.contains('collapsed')) {
      detailLeftCollapsed = true;
      detailSidebarLeft.classList.add('collapsed');
    }
  }
};

// Sidebar resize
const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;
let startX = 0;
let startWidth = 0;
resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startWidth = sidebar.offsetWidth;
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});
document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const diff = e.clientX - startX;
  const newWidth = Math.max(250, Math.min(600, startWidth + diff));
  sidebar.style.width = newWidth + 'px';
});
document.addEventListener('mouseup', () => {
  if (!isResizing) return;
  isResizing = false;
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
});

// Detail sidebar toggles (left and right)
const detailSidebarLeft = document.getElementById('detail-sidebar-left');
const detailSidebarRight = document.getElementById('detail-sidebar-right');
const detailToggleLeft = document.getElementById('detail-toggle-left');
const detailToggleRight = document.getElementById('detail-toggle-right');
const detailSidebarToggleLeft = document.getElementById('detail-sidebar-toggle-left');
const detailSidebarToggleRight = document.getElementById('detail-sidebar-toggle-right');

let detailLeftCollapsed = false;
let detailRightCollapsed = false;

// Toggle left detail sidebar
function toggleDetailLeft() {
  detailLeftCollapsed = !detailLeftCollapsed;
  detailSidebarLeft.classList.toggle('collapsed', detailLeftCollapsed);
  detailToggleLeft.classList.toggle('show', detailLeftCollapsed);
  detailToggleLeft.textContent = detailLeftCollapsed ? 'â–¶' : 'â—€';
}

// Toggle right detail sidebar
function toggleDetailRight() {
  detailRightCollapsed = !detailRightCollapsed;
  detailSidebarRight.classList.toggle('collapsed', detailRightCollapsed);
  detailToggleRight.classList.toggle('show', detailRightCollapsed);
  detailToggleRight.textContent = detailRightCollapsed ? 'â—€' : 'â–¶';
}

if(detailSidebarToggleLeft) detailSidebarToggleLeft.onclick = toggleDetailLeft;
if(detailToggleLeft) detailToggleLeft.onclick = toggleDetailLeft;
if(detailSidebarToggleRight) detailSidebarToggleRight.onclick = toggleDetailRight;
if(detailToggleRight) detailToggleRight.onclick = toggleDetailRight;

// Bottom bar toggle
const bottomBar = document.getElementById('bottom-bar');
const bottomBarToggle = document.getElementById('bottom-bar-toggle');
const detailToggleBottom = document.getElementById('detail-toggle-bottom');
let bottomBarCollapsed = false;

function toggleBottomBar() {
  bottomBarCollapsed = !bottomBarCollapsed;
  if(bottomBar) bottomBar.classList.toggle('collapsed', bottomBarCollapsed);
  if(detailToggleBottom) {
    detailToggleBottom.classList.toggle('show', bottomBarCollapsed);
    detailToggleBottom.textContent = bottomBarCollapsed ? 'â–²' : 'â–¼';
  }
}

if(bottomBarToggle) bottomBarToggle.onclick = toggleBottomBar;
if(detailToggleBottom) detailToggleBottom.onclick = toggleBottomBar;

// Initialize map
// GEE AOI: Rectangle([28.62, 40.75, 29.56, 41.18])
const istanbulBounds = [[40.75, 28.62], [41.18, 29.56]];

const map = L.map('map', {
  center: [40.965, 29.09], // AOI merkezi
  zoom: 11,
  minZoom: 10,
  maxZoom: 18,
  zoomControl: true,
  scrollWheelZoom: true,
  doubleClickZoom: false,  // Ã‡ift tÄ±klama ile ani zoom kapalÄ±
  dragging: true,
  zoomSnap: 0.10,  // Zoom adÄ±mlarÄ±nÄ± 0.10'ar yapar (Ã§ok yumuÅŸak)
  zoomDelta: 0.5,  // Butonlar iÃ§in zoom deÄŸiÅŸimi
  wheelPxPerZoomLevel: 120  // Mouse wheel hassasiyeti (yavaÅŸ zoom)
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap',
  maxZoom: 18
}).addTo(map);

// Satellite tile layer
let satelliteTileLayer = null;
let currentSatelliteYear = 2018;
let currentSatelliteQuarter = 1;
let currentSatelliteIndex = 'ndvi';
let satelliteOpacity = 0.7;

// Initialize year/quarter from dropdown selected value
function initializeSatelliteFromDropdown() {
  const dropdown = document.getElementById('satellite-time');
  if (dropdown && dropdown.value) {
    const [year, quarter] = dropdown.value.split('_');
    currentSatelliteYear = parseInt(year);
    currentSatelliteQuarter = parseInt(quarter);
    console.log(`ğŸ›°ï¸ Initialized from dropdown: ${currentSatelliteYear} Q${currentSatelliteQuarter}`);
  }
}

function updateSatelliteTileLayer() {
  // Remove old layer
  if (satelliteTileLayer) {
    map.removeLayer(satelliteTileLayer);
  }
  
  // Check if layer should be visible
  const isVisible = document.getElementById('tile-layer-toggle').checked;
  if (!isVisible) return;
  
  // Create new tile layer
  const tileUrl = `http://localhost:8000/api/tiles/${currentSatelliteYear}/${currentSatelliteQuarter}/${currentSatelliteIndex}/{z}/{x}/{y}.png`;
  
  satelliteTileLayer = L.tileLayer(tileUrl, {
    attribution: 'Â© Sentinel-2 ESA',
    minZoom: 12,  // Daha yakÄ±ndan baÅŸlat (mozaik gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ engelle)
    maxZoom: 15,
    opacity: satelliteOpacity,
    tileSize: 256,
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  satelliteTileLayer.addTo(map);
  console.log(`ğŸ›°ï¸ Tile layer updated: ${currentSatelliteYear} Q${currentSatelliteQuarter}, ${currentSatelliteIndex}`);
}

// Satellite controls event listeners
document.getElementById('satellite-time').addEventListener('change', (e) => {
  const [year, quarter] = e.target.value.split('_');
  currentSatelliteYear = parseInt(year);
  currentSatelliteQuarter = parseInt(quarter);
  updateSatelliteTileLayer();
});

// Satellite index buttons (using view-btn with data-index)
document.querySelectorAll('.view-btn[data-index]').forEach(btn => {
  btn.addEventListener('click', (e) => {
    // Remove active class from satellite buttons only
    document.querySelectorAll('.view-btn[data-index]').forEach(b => b.classList.remove('active'));
    // Add active to clicked button
    btn.classList.add('active');
    
    // Update index
    currentSatelliteIndex = btn.dataset.index;
    updateSatelliteTileLayer();
  });
});

document.getElementById('tile-opacity').addEventListener('input', (e) => {
  satelliteOpacity = e.target.value / 100;
  document.getElementById('opacity-value').textContent = e.target.value + '%';
  
  if (satelliteTileLayer) {
    satelliteTileLayer.setOpacity(satelliteOpacity);
  }
});

document.getElementById('tile-layer-toggle').addEventListener('change', (e) => {
  if (e.target.checked) {
    updateSatelliteTileLayer();
  } else if (satelliteTileLayer) {
    map.removeLayer(satelliteTileLayer);
    satelliteTileLayer = null;
  }
});

// Zoom kontrolÃ¼ - DÃ¼ÅŸÃ¼k zoom'da tile layer'Ä± gizle
map.on('zoomend', () => {
  const currentZoom = map.getZoom();
  const checkbox = document.getElementById('tile-layer-toggle');
  
  // Zoom 12'den kÃ¼Ã§Ã¼kse ve layer aÃ§Ä±ksa, otomatik kapat
  if (currentZoom < 12 && checkbox.checked && satelliteTileLayer) {
    map.removeLayer(satelliteTileLayer);
    satelliteTileLayer = null;
    console.log('â„¹ï¸ Zoom seviyesi dÃ¼ÅŸÃ¼k - tile layer gizlendi');
  }
  // Zoom 12'den bÃ¼yÃ¼kse ve checkbox iÅŸaretliyse, layer'Ä± gÃ¶ster
  else if (currentZoom >= 12 && checkbox.checked && !satelliteTileLayer) {
    updateSatelliteTileLayer();
    console.log('âœ… Zoom seviyesi yeterli - tile layer gÃ¶steriliyor');
  }
});

// Initialize satellite layer
initializeSatelliteFromDropdown();
updateSatelliteTileLayer();

let gridLayers = [];
let currentTimeframe = 'now';
let currentLayer = 'all';
let currentView = 'single';
let allData = null;

// Timeframe mapping
const timeframes = ['now', '6m', '12m'];
const timeframeDates = ['Ekim 2024', 'Nisan 2025', 'Ekim 2025'];

// Load detailed data
async function loadData() {
  try {
    const r = await fetch('/api/istanbul/detailed', {
      headers: {Authorization: `Bearer ${token}`}
    });
    if(!r.ok) {
      console.error('API Response:', r.status, r.statusText);
      throw new Error(`Failed to load data: ${r.status}`);
    }
    
    allData = await r.json();
    console.log('âœ… Loaded data:', allData);
    
    // Render grid
    renderGrid(currentTimeframe, currentLayer);
    
    // Update stats
    updateStats();
    
    // Create charts
    createCharts();
    
    // Update district list
    updateDistrictList();
    
    // Update summary
    updateSummary();
    
  } catch(err) {
    console.error('âŒ Error loading data:', err);
    
    // Show error message on map
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(239, 68, 68, 0.95);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    `;
    errorDiv.textContent = 'âš ï¸ Veri yÃ¼klenemedi. Backend Ã§alÄ±ÅŸÄ±yor mu?';
    document.querySelector('.map-container').appendChild(errorDiv);
  } finally {
    // Always hide loading spinner
    const loadingElement = document.getElementById('loading');
    if(loadingElement) {
      loadingElement.style.display = 'none';
    }
  }
}

// Render regions as large circular markers
function renderGrid(timeframe, layer) {
  // Clear existing layers
  gridLayers.forEach(l => map.removeLayer(l));
  gridLayers = [];
  
  if(!allData) return;
  
  allData.grid.forEach(region => {
    const data = region[timeframe];
    
    // Determine color and size based on layer
    let color, radius;
    if(layer === 'all') {
      // Composite color based on green percentage
      const greenPercent = data.green;
      color = greenPercent > 40 ? '#10b981' : greenPercent > 25 ? '#f59e0b' : '#ef4444';
      radius = 2000; // 2km radius
    } else if(layer === 'green') {
      color = '#10b981';
      radius = (data.green / 100) * 3000;
    } else if(layer === 'grey') {
      color = '#ef4444';
      radius = (data.grey / 100) * 3000;
    } else if(layer === 'water') {
      color = '#3b82f6';
      radius = (data.water / 100) * 3000;
    }
    
    // Create circle marker
    const circle = L.circle([region.lat, region.lng], {
      color: 'white',
      weight: 3,
      fillColor: color,
      fillOpacity: 0.6,
      radius: radius
    }).addTo(map);
    
    circle.bindPopup(`
      <div style="padding:12px;min-width:220px">
        <div style="font-weight:900;font-size:16px;margin-bottom:10px;color:#0284c7">${region.name}</div>
        <div style="font-size:14px;line-height:1.8">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span>ğŸŒ³ YeÅŸil:</span>
            <strong style="color:#10b981">${data.green}%</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px">
            <span>ğŸ¢ Beton:</span>
            <strong style="color:#ef4444">${data.grey}%</strong>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>ğŸ’§ Su:</span>
            <strong style="color:#3b82f6">${data.water}%</strong>
          </div>
        </div>
      </div>
    `);
    
    gridLayers.push(circle);
  });
}

// Update stats
function updateStats() {
  const pred = allData.predictions.find(p => p.period === currentTimeframe);
  if(!pred) return;
  
  // Check if stat elements exist before updating
  const statGreen = document.getElementById('stat-green');
  const statGrey = document.getElementById('stat-grey');
  const statWater = document.getElementById('stat-water');
  
  if(statGreen) statGreen.textContent = pred.green + '%';
  if(statGrey) statGrey.textContent = pred.grey + '%';
  if(statWater) statWater.textContent = pred.water + '%';
}

// Create charts
function createCharts() {
  const trendCanvas = document.getElementById('trendChart');
  if(!trendCanvas) {
    console.log('âš ï¸ Chart canvas not found');
    return;
  }
  
  try {
    // Historical trend chart - horizontal timeline
    const trendCtx = trendCanvas.getContext('2d');
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: allData.historical.map(h => h.year),
        datasets: [
          {
            label: 'ğŸŒ³ YeÅŸil Alan',
            data: allData.historical.map(h => h.green),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.15)',
            borderWidth: 3,
            tension: 0.3,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          },
          {
            label: 'ğŸ¢ Beton',
            data: allData.historical.map(h => h.grey),
            borderColor: '#9ca3af',
            backgroundColor: 'rgba(156, 163, 175, 0.15)',
            borderWidth: 3,
            tension: 0.3,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#9ca3af',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          },
          {
            label: 'ğŸ’§ Su AlanÄ±',
            data: allData.historical.map(h => h.water),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.15)',
            borderWidth: 3,
            tension: 0.3,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'right',
            labels: {
              color: 'white',
              font: {size: 13, weight: '600'},
              padding: 15,
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.95)',
            titleColor: 'white',
            bodyColor: 'white',
            borderColor: 'rgba(59, 130, 246, 0.5)',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            min: 0,
            max: 70,
            ticks: {
              stepSize: 10,
              color: 'rgba(255, 255, 255, 0.7)',
              font: {size: 12},
              callback: function(value) {
                return value + '%';
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.08)',
              drawBorder: false
            }
          },
          x: {
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: {size: 12, weight: '600'}
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
    console.log('âœ… Chart created successfully');
  } catch(err) {
    console.error('âŒ Error creating chart:', err);
  }
}

// Update district list
function updateDistrictList() {
  const list = document.getElementById('district-list');
  if(!list || !allData || !allData.district_changes) {
    console.log('âš ï¸ District list element or data not found');
    return;
  }
  
  list.innerHTML = '';
  
  allData.district_changes.forEach(d => {
    const item = document.createElement('div');
    item.className = 'district-item';
    item.innerHTML = `
      <div class="district-name">${d.name}</div>
      <div class="district-stats">
        <span class="district-green">${d.now_green}% â†’ ${d.future_green}%</span>
        <span class="district-risk risk-${d.risk}">${d.risk}</span>
      </div>
    `;
    list.appendChild(item);
  });
}

// Update summary
function updateSummary() {
  if(!allData || !allData.summary) {
    console.log('âš ï¸ Summary data not found');
    return;
  }
  
  const s = allData.summary;
  const totalArea = document.getElementById('total-area');
  const population = document.getElementById('population');
  const greenPerCapita = document.getElementById('green-per-capita');
  const lossRate = document.getElementById('loss-rate');
  
  if(totalArea) totalArea.textContent = s.total_area_km2.toLocaleString() + ' kmÂ²';
  if(population) population.textContent = s.population.toLocaleString();
  if(greenPerCapita) greenPerCapita.textContent = s.green_per_capita_m2.toFixed(2) + ' mÂ²';
  if(lossRate) lossRate.textContent = s.green_loss_rate_yearly.toFixed(1) + '%';
}

// Timeline slider (only if element exists)
const timelineSlider = document.getElementById('timeline-slider');
if(timelineSlider) {
  timelineSlider.addEventListener('input', (e) => {
    const index = parseInt(e.target.value);
    currentTimeframe = timeframes[index];
    
    // Update labels
    document.querySelectorAll('.timeline-label').forEach((label, i) => {
      label.classList.toggle('active', i === index);
    });
    
    // Update date
    const currentDateEl = document.getElementById('current-date');
    if(currentDateEl) currentDateEl.textContent = timeframeDates[index];
    
    // Re-render grid
    renderGrid(currentTimeframe, currentLayer);
    updateStats();
  });
}

// Layer buttons (using view-btn with data-layer)
document.querySelectorAll('.view-btn[data-layer]').forEach(btn => {
  btn.addEventListener('click', () => {
    // Remove active class from layer buttons only
    document.querySelectorAll('.view-btn[data-layer]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentLayer = btn.dataset.layer;
    renderGrid(currentTimeframe, currentLayer);
  });
});

// Note: View mode buttons removed - using single view only

// Initial load - wait for DOM to be ready
console.log('ğŸ”„ Script loaded, readyState:', document.readyState);

if (document.readyState === 'loading') {
  console.log('â³ DOM still loading, adding event listener');
  document.addEventListener('DOMContentLoaded', () => {
    console.log('âœ… DOMContentLoaded fired, calling loadData()');
    loadData();
  });
} else {
  // DOM already loaded
  console.log('âœ… DOM already loaded, calling loadData() immediately');
  loadData();
}
</script>
</body>
</html>
