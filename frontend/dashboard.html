<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/png" href="/images/favicon.png"/>
<title>Dashboard â€” Greygreen</title>

<!-- 
  ============================================================================
  GREY VS GREEN ATLAS - ANA DASHBOARD
  ============================================================================
  
  AÃ§Ä±klama:
    KullanÄ±cÄ±larÄ±n giriÅŸ yaptÄ±ktan sonra yÃ¶nlendirildiÄŸi ana sayfa.
    Åehirlerin yeÅŸil/gri alan Ã¶zetlerini gÃ¶sterir.
    Sadece Ä°stanbul iÃ§in detaylÄ± analiz aktif.
  
  Ã–zellikler:
    - Ãœst menÃ¼ Ã§ubuÄŸu (kullanÄ±cÄ± bilgisi, Ã§Ä±kÄ±ÅŸ, arama)
    - Yan panel (sidebar): menÃ¼ ve Ã¶zet istatistikler
    - Sidebar aÃ§Ä±lÄ±p kapanabilir ve sÃ¼rÃ¼klenip geniÅŸletilebilir
    - Ä°stanbul kartÄ±nda "DetaylÄ± Analiz" butonu
    - DiÄŸer ÅŸehirler pasif ("YakÄ±nda Aktif")
  
  Navigasyon:
    - Haritalar â†’ map.html
    - Ä°stanbul DetaylÄ± Analiz â†’ istanbul-detail.html
  
  API Ã‡aÄŸrÄ±larÄ±:
    - GET /me â†’ KullanÄ±cÄ± bilgisi
    - GET /api/city/istanbul â†’ Ä°stanbul Ã¶zet verileri
    - POST /auth/login â†’ Oturum aÃ§ma (redirect iÃ§in)
  
  ============================================================================
-->

<!-- Ortak CSS -->
<link rel="stylesheet" href="/css/common.css">
<!-- Dashboard'a Ã–zel CSS -->
<link rel="stylesheet" href="/css/dashboard.css">

</head>
<body>
<!-- Top Bar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="sidebar-toggle" id="sidebar-toggle" title="Sidebar AÃ§/Kapat">â˜°</button>
    <div class="topbar-brand" style="cursor:default">ğŸŒ Grey vs Green Atlas</div>
    <div class="topbar-search">
      <input type="text" placeholder="Åehir veya analiz ara..."/>
    </div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn">ğŸ”” <span>3</span></button>
    <div class="topbar-user">
      <span>ğŸ‘¤</span>
      <span id="who">YÃ¼kleniyor...</span>
    </div>
    <button class="topbar-logout" id="logout">
      <span>ğŸšª</span>
      <span>Ã‡Ä±kÄ±ÅŸ</span>
    </button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-resizer" id="sidebar-resizer"></div>
    <!-- Ana MenÃ¼ -->
    <div class="sidebar-section">
      <div class="sidebar-title">Ana MenÃ¼</div>
      <nav class="nav">
        <a href="/dashboard.html" id="nav-dashboard" class="active">
          <span>ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/map.html" id="nav-map">
          <span>ğŸ—ºï¸</span>
          <span>Harita</span>
        </a>
        <a href="/istanbul-detail.html" id="nav-istanbul">
          <span>ğŸ”¬</span>
          <span>Ä°stanbul Detay</span>
        </a>
      </nav>
    </div>
    
    <!-- Veri YÃ¶netimi -->
    <div class="sidebar-section">
      <div class="sidebar-title">Veri YÃ¶netimi</div>
      <nav class="nav">
        <a href="/data-sources.html" id="nav-data-sources">
          <span>ğŸ›°ï¸</span>
          <span>Veri KaynaklarÄ±</span>
        </a>
        <a href="/data-upload.html" id="nav-data-upload">
          <span>ğŸ“¤</span>
          <span>Veri Setleri</span>
        </a>
        <a href="/reports.html" id="nav-reports">
          <span>ğŸ§¾</span>
          <span>Raporlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Sistem -->
    <div class="sidebar-section">
      <div class="sidebar-title">Sistem</div>
      <nav class="nav">
        <a href="/settings.html" id="nav-settings">
          <span>âš™ï¸</span>
          <span>Ayarlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Ã–zet Ä°statistikler -->
    <div class="sidebar-footer">
      <div class="sidebar-title">Ã–zet Ä°statistikler</div>
      <div class="sidebar-stats">
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Toplam Åehir</span>
          <span class="sidebar-stat-value">5</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Son GÃ¼ncelleme</span>
          <span class="sidebar-stat-value">BugÃ¼n</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Aktif Analiz</span>
          <span class="sidebar-stat-value">1</span>
        </div>
      </div>
      
      <!-- KullanÄ±cÄ± KartÄ± -->
      <div class="sidebar-user-card" style="margin-top: 16px;">
        <div class="user-avatar">ğŸ‘¤</div>
        <div class="user-info">
          <div class="user-name" id="sidebar-user-name">YÃ¼kleniyor...</div>
          <div class="user-role">Admin</div>
        </div>
      </div>
    </div>
  </aside>
  
  <main class="main">
    <div class="header">
      <h1>TÃ¼rkiye Geneli Arazi KullanÄ±m OranlarÄ±</h1>
      <p>TÃ¼rkiye'nin bÃ¼yÃ¼k ÅŸehirlerinde yeÅŸil alan ve beton deÄŸiÅŸimini takip edin</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
    <img src="./images/agac-resimleri-rooteto4.jpg" alt="YeÅŸil Alan" class="stat-icon">
        <div class="stat-value">31.2%</div>
        <div class="stat-label">Ortalama YeÅŸil Alan</div>
      </div>
      <div class="stat-card">
    <img src="./images/R.jpg" alt="Beton Alan" class="stat-icon">
        <div class="stat-value">61.4%</div>
        <div class="stat-label">Ortalama Beton</div>
      </div>
      <div class="stat-card">
    <img src="./images/OIP_1.webp" alt="Su KaynaklarÄ±" class="stat-icon">
        <div class="stat-value">7.4%</div>
        <div class="stat-label">Su KaynaklarÄ±</div>
      </div>
    </div>

    <div class="cards">
      <div class="card" data-city="istanbul">
        <h3>Ä°stanbul</h3>
        <p>TÃ¼rkiye'nin en bÃ¼yÃ¼k metropolÃ¼. BoÄŸaz'Ä±n iki yakasÄ±nda yeÅŸil alan ve beton deÄŸiÅŸimini keÅŸfedin.</p>
        <button class="btn btn-kpi" data-city="istanbul">ğŸ“Š Ã–zet Ä°statistikler</button>
        <div class="button-grid">
          <button class="btn btn-detail" onclick="location.href='/istanbul-detail.html'">ğŸ”¬ DetaylÄ± Analiz</button>
          <button class="btn btn-trend" onclick="location.href='/trend-prediction.html'">ğŸ“ˆ Trend Tahmini</button>
        </div>
        <div class="kpis" id="kpis-istanbul" style="display:none">
          <div class="k"><div class="muted">ğŸŒ³ YeÅŸil</div><b class="k-value" id="k-green-istanbul">â€“</b></div>
          <div class="k"><div class="muted">ğŸ¢ Beton</div><b class="k-value" id="k-grey-istanbul">â€“</b></div>
          <div class="k"><div class="muted">ğŸ’§ Su</div><b class="k-value" id="k-water-istanbul">â€“</b></div>
        </div>
        <div class="note" id="note-istanbul" style="display:none"></div>
      </div>

      <div class="card card-disabled" data-city="ankara">
  <h3>Ankara</h3>
  <p>BaÅŸkent Ankara'nÄ±n yeÅŸil alan analizi yakÄ±nda hazÄ±r olacak. AnÄ±tkabir ve Ã§evre yeÅŸil alanlarÄ±n takibi.</p>
  <button class="btn btn-disabled" disabled>YakÄ±nda Aktif</button>
      </div>

      <div class="card card-disabled" data-city="izmir">
  <h3>Ä°zmir</h3>
  <p>Ege'nin incisi Ä°zmir'in sahil ÅŸeridi ve kent iÃ§i yeÅŸil alanlarÄ±n analizi Ã§ok yakÄ±nda.</p>
  <button class="btn btn-disabled" disabled>YakÄ±nda Aktif</button>
      </div>

      <div class="card card-disabled" data-city="bursa">
  <h3>Bursa</h3>
  <p>YeÅŸil Bursa'nÄ±n tarihi dokusu ve doÄŸal gÃ¼zellikleri yakÄ±nda analiz edilecek.</p>
  <button class="btn btn-disabled" disabled>YakÄ±nda Aktif</button>
      </div>
    </div>
  </main>
</div>
<script>
// ============================================================================
// KÄ°MLÄ°K DOÄRULAMA (Authentication Check)
// ============================================================================

// LocalStorage'dan JWT token'Ä± al
const token = localStorage.getItem('token');

// Token yoksa login sayfasÄ±na yÃ¶nlendir
if (!token) {
  location.href = '/';
}

/**
 * Mevcut kullanÄ±cÄ±nÄ±n bilgilerini getir ve sayfada gÃ¶ster
 * API: GET /me
 */
async function whoami() {
  try {
    const response = await fetch('/me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    // Token geÃ§ersizse login'e yÃ¶nlendir
    if (!response.ok) {
      localStorage.removeItem('token');
      location.href = '/';
      return;
    }
    
    // KullanÄ±cÄ± email'ini topbar'da gÃ¶ster
    const user = await response.json();
    document.getElementById('who').textContent = user.email;
    
    // Sidebar'daki kullanÄ±cÄ± bilgisini de gÃ¼ncelle
    const sidebarUserName = document.getElementById('sidebar-user-name');
    if (sidebarUserName) {
      sidebarUserName.textContent = user.email;
    }
    
  } catch (error) {
    console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', error);
    location.href = '/';
  }
}

// Sayfa yÃ¼klenince kullanÄ±cÄ± bilgisini getir
whoami();


// ============================================================================
// Ã‡IKIÅ Ä°ÅLEMÄ° (Logout)
// ============================================================================

/**
 * Ã‡Ä±kÄ±ÅŸ butonu tÄ±klandÄ±ÄŸÄ±nda token'Ä± sil ve login'e yÃ¶nlendir
 */
document.getElementById('logout').onclick = () => {
  localStorage.removeItem('token');
  location.href = '/';
};


// ============================================================================
// Ä°STANBUL VERÄ°LERÄ°NÄ° GÃ–STER (Istanbul Data Display)
// ============================================================================

/**
 * KPI butonlarÄ± iÃ§in genel toggle fonksiyonu
 * Her ÅŸehir iÃ§in baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r
 */
const kpiStates = {}; // Her ÅŸehir iÃ§in ayrÄ± state

// TÃ¼m KPI butonlarÄ±na event listener ekle
document.querySelectorAll('.btn-kpi').forEach(btn => {
  const cityName = btn.getAttribute('data-city');
  kpiStates[cityName] = false; // BaÅŸlangÄ±Ã§ta kapalÄ±
  
  btn.onclick = async (event) => {
    event.stopPropagation();
    event.preventDefault();
    
    const card = event.target.closest('.card');
    const kpisElement = document.getElementById(`kpis-${cityName}`);
    const noteElement = document.getElementById(`note-${cityName}`);
    
    // Toggle: EÄŸer aÃ§Ä±ksa kapat, kapalÄ±ysa aÃ§
    if (kpiStates[cityName]) {
      kpisElement.style.display = 'none';
      noteElement.style.display = 'none';
      card.classList.remove('kpi-expanded');
      kpiStates[cityName] = false;
      console.log(`${cityName} KPI kapatÄ±ldÄ±`);
      return;
    }
    
    // KPI'yÄ± aÃ§ - veriyi Ã§ek
    console.log(`${cityName} KPI aÃ§Ä±lÄ±yor...`);
    try {
      const response = await fetch(`/api/city/${cityName}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      
      if (!response.ok) {
        alert('Veri alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.');
        return;
      }
      
      const data = await response.json();
      
      // KPI kartlarÄ±nÄ± doldur
      document.getElementById(`k-green-${cityName}`).textContent = data.now.green + '%';
      document.getElementById(`k-grey-${cityName}`).textContent = data.now.grey + '%';
      document.getElementById(`k-water-${cityName}`).textContent = data.now.water + '%';
      
      // Veri kaynaÄŸÄ± notunu gÃ¶ster
      if (noteElement) {
        noteElement.textContent = data.note;
        noteElement.style.display = 'block';
      }
      
      // KPI kartlarÄ±nÄ± gÃ¶rÃ¼nÃ¼r yap
      kpisElement.style.display = 'grid';
      card.classList.add('kpi-expanded');
      kpiStates[cityName] = true;
      console.log(`${cityName} KPI aÃ§Ä±ldÄ±`);
      
    } catch (error) {
      console.error(`${cityName} verileri yÃ¼klenemedi:`, error);
      alert('Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
    }
  };
});


// ============================================================================
// SIDEBAR AÃ‡/KAPA (Sidebar Toggle)
// ============================================================================

const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('.main');
let isCollapsed = false;

/**
 * Sidebar toggle butonu tÄ±klandÄ±ÄŸÄ±nda yan paneli aÃ§/kapat
 * Buton ikonu ve tooltip'i de deÄŸiÅŸir (â˜° â†” âœ•)
 */
sidebarToggle.onclick = () => {
  isCollapsed = !isCollapsed;
  // 'collapsed' class'Ä±nÄ± ekle/Ã§Ä±kar (CSS'de display:none)
  sidebar.classList.toggle('collapsed', isCollapsed);
  // Main content'e de class ekle/Ã§Ä±kar
  if (mainContent) {
    mainContent.classList.toggle('sidebar-collapsed', isCollapsed);
  }
  // Buton iÃ§eriÄŸini deÄŸiÅŸtir
  sidebarToggle.textContent = isCollapsed ? 'â˜°' : 'âœ•';
  sidebarToggle.title = isCollapsed ? 'Sidebar AÃ§' : 'Sidebar Kapat';
  // Renk deÄŸiÅŸimi iÃ§in class ekle/Ã§Ä±kar
  if (isCollapsed) {
    sidebarToggle.classList.add('toggled');
  } else {
    sidebarToggle.classList.remove('toggled');
    sidebar.style.width = '';
    document.documentElement.style.setProperty('--sidebar-width', '300px');
  }
};


// ============================================================================
// SIDEBAR GENÄ°ÅLÄ°K AYARI (Sidebar Resize)
// ============================================================================

const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;  // Åu an sÃ¼rÃ¼kleniyor mu?
let startX = 0;          // SÃ¼rÃ¼kleme baÅŸlangÄ±Ã§ X koordinatÄ±
let startWidth = 0;      // SÃ¼rÃ¼kleme baÅŸlangÄ±Ã§ sidebar geniÅŸliÄŸi

// SÃ¼rÃ¼kleme sÄ±rasÄ±nda transition'Ä± kaldÄ±r
function removeSidebarTransition() {
  sidebar.style.transition = 'none';
}
// SÃ¼rÃ¼kleme bitince transition'Ä± geri ekle
function restoreSidebarTransition() {
  sidebar.style.transition = '';
}

/**
 * Resizer Ã§ubuÄŸuna mousedown yapÄ±ldÄ±ÄŸÄ±nda sÃ¼rÃ¼klemeyi baÅŸlat
 */
resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startWidth = sidebar.offsetWidth;
  removeSidebarTransition();
  // GÃ¶rsel feedback: resizer ve cursor deÄŸiÅŸir
  resizer.classList.add('resizing');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';  // Metin seÃ§imini engelle
});

/**
 * Mouse hareket ederken sidebar geniÅŸliÄŸini ayarla
 * Min: 250px, Max: 600px
 */
document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;

  // Hareket mesafesini hesapla
  const diff = e.clientX - startX;
  const minSidebar = 60; // px, bu deÄŸerin altÄ± kapalÄ± sayÄ±lÄ±r
  const maxSidebar = 600;
  const newWidth = Math.max(minSidebar, Math.min(maxSidebar, startWidth + diff));

  // Sidebar geniÅŸliÄŸini gÃ¼ncelle
  sidebar.style.width = newWidth + 'px';
  document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');

  // EÄŸer Ã§ok daraltÄ±ldÄ±ysa otomatik kapat
  if (newWidth <= minSidebar + 2) {
    sidebar.classList.add('collapsed');
    if (mainContent) mainContent.classList.add('sidebar-collapsed');
    isCollapsed = true;
  } else {
    sidebar.classList.remove('collapsed');
    if (mainContent) mainContent.classList.remove('sidebar-collapsed');
    isCollapsed = false;
  }
});

/**
 * Mouse bÄ±rakÄ±ldÄ±ÄŸÄ±nda sÃ¼rÃ¼klemeyi bitir
 */
document.addEventListener('mouseup', () => {
  if (!isResizing) return;
  isResizing = false;
  resizer.classList.remove('resizing');
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
  restoreSidebarTransition();
});


// ============================================================================
// BAÅLANGIÃ‡ AYARLARI (Initialization)
// ============================================================================

// Sidebar'Ä±n baÅŸlangÄ±Ã§ geniÅŸliÄŸini CSS deÄŸiÅŸkenine kaydet
document.documentElement.style.setProperty(
  '--sidebar-width',
  sidebar.offsetWidth + 'px'
);
</script>
</body>
</html>
