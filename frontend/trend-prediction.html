<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trend Tahmini â€” Grey vs Green Atlas</title>

<!-- 
  ============================================================================
  GREY VS GREEN ATLAS - TREND TAHMÄ°NÄ°
  ============================================================================
  
  AÃ§Ä±klama:
    UNET + Conv3D temporal modeli kullanarak gelecek dÃ¶nem (t+1) tahminleri.
    Ä°stanbul iÃ§in yeÅŸil alan, beton ve su kaynaklarÄ±nÄ±n trend analizi.
  
  Ã–zellikler:
    - Ä°nteraktif harita (Leaflet)
    - Zaman Ã§izelgesi slider'Ä±
    - KarÅŸÄ±laÅŸtÄ±rma modu (split-screen)
    - Tahmin overlay'leri
    - Ä°statistik paneli
  
  Model:
    - UNET: 4-class segmentation (background, green, gray, water)
    - Conv3D: Temporal prediction (8 quarters â†’ t+1)
  
  ============================================================================
-->

<!-- Ortak CSS -->
<link rel="stylesheet" href="/css/common.css">
<!-- Trend Prediction CSS -->
<link rel="stylesheet" href="/css/trend-prediction.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

</head>
<body>
<!-- Top Bar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="sidebar-toggle" id="sidebar-toggle" title="Sidebar AÃ§/Kapat">â˜°</button>
    <div class="topbar-brand" style="cursor:default">ğŸŒ Grey vs Green Atlas</div>
    <div class="topbar-search">
      <input type="text" placeholder="Åehir veya analiz ara..."/>
    </div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn">ğŸ”” <span>3</span></button>
    <div class="topbar-user">
      <span>ğŸ‘¤</span>
      <span id="who">YÃ¼kleniyor...</span>
    </div>
    <button class="topbar-logout" id="logout">
      <span>ğŸšª</span>
      <span>Ã‡Ä±kÄ±ÅŸ</span>
    </button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-resizer" id="sidebar-resizer"></div>
    <!-- Ana MenÃ¼ -->
    <div class="sidebar-section">
      <div class="sidebar-title">Ana MenÃ¼</div>
      <nav class="nav">
        <a href="/dashboard.html" id="nav-dashboard">
          <span>ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/map.html" id="nav-map">
          <span>ğŸ—ºï¸</span>
          <span>Harita</span>
        </a>
        <a href="/istanbul-detail.html" id="nav-istanbul">
          <span>ğŸ”¬</span>
          <span>Ä°stanbul Detay</span>
        </a>
        <a href="/trend-prediction.html" id="nav-trend" class="active">
          <span>ğŸ“ˆ</span>
          <span>Trend Tahmini</span>
        </a>
      </nav>
    </div>
    
    <!-- Veri YÃ¶netimi -->
    <div class="sidebar-section">
      <div class="sidebar-title">Veri YÃ¶netimi</div>
      <nav class="nav">
        <a href="/data-sources.html" id="nav-data-sources">
          <span>ğŸ›°ï¸</span>
          <span>Veri KaynaklarÄ±</span>
        </a>
        <a href="/data-upload.html" id="nav-data-upload">
          <span>ğŸ“¤</span>
          <span>Veri Setleri</span>
        </a>
        <a href="/reports.html" id="nav-reports">
          <span>ğŸ§¾</span>
          <span>Raporlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Sistem -->
    <div class="sidebar-section">
      <div class="sidebar-title">Sistem</div>
      <nav class="nav">
        <a href="/settings.html" id="nav-settings">
          <span>âš™ï¸</span>
          <span>Ayarlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Model Bilgisi -->
    <div class="sidebar-footer">
      <div class="sidebar-title">Model Bilgisi</div>
      <div class="sidebar-stats">
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Model</span>
          <span class="sidebar-stat-value">UNET+Conv3D</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Sequence</span>
          <span class="sidebar-stat-value">8 Quarters</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">DoÄŸruluk</span>
          <span class="sidebar-stat-value">~94%</span>
        </div>
      </div>
    </div>
  </aside>
  
  <main class="main">
    <div class="header">
      <h1>Ä°stanbul Trend Tahmini</h1>
      <p>Yapay zeka ile gelecek dÃ¶nem yeÅŸil alan, beton ve su kaynaklarÄ±nÄ±n tahmini</p>
    </div>

    <!-- Kontrol Paneli -->
    <div class="control-panel">
      <div class="control-group">
        <label>ğŸ“… GÃ¶rÃ¼ntÃ¼leme Modu</label>
        <div class="mode-buttons">
          <button class="mode-btn active" data-mode="prediction">Tahmin</button>
          <button class="mode-btn" data-mode="comparison">KarÅŸÄ±laÅŸtÄ±rma</button>
          <button class="mode-btn" data-mode="difference">Fark Analizi</button>
        </div>
      </div>
      
      <div class="control-group">
        <label>ğŸ¨ Overlay ÅeffaflÄ±k</label>
        <input type="range" id="opacity-slider" min="0" max="100" value="70" />
        <span id="opacity-value">70%</span>
      </div>
      
      <div class="control-group">
        <label>ğŸ” Katman SeÃ§imi</label>
        <div class="layer-checkboxes">
          <label><input type="checkbox" id="layer-green" checked /> ğŸŒ³ YeÅŸil Alan</label>
          <label><input type="checkbox" id="layer-gray" checked /> ğŸ¢ Beton</label>
          <label><input type="checkbox" id="layer-water" checked /> ğŸ’§ Su</label>
        </div>
      </div>
    </div>

    <!-- Harita Konteyneri -->
    <div class="map-container">
      <div id="map" class="map"></div>
      
      <!-- KarÅŸÄ±laÅŸtÄ±rma Modu iÃ§in Ä°kinci Harita -->
      <div id="map-compare" class="map map-hidden"></div>
      
      <!-- Legend -->
      <div class="map-legend">
        <div class="legend-title">SÄ±nÄ±flandÄ±rma</div>
        <div class="legend-item">
          <span class="legend-color" style="background: #10b981;"></span>
          <span>YeÅŸil Alan</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #6b7280;"></span>
          <span>Beton</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #3b82f6;"></span>
          <span>Su KaynaklarÄ±</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #000000;"></span>
          <span>Arka Plan</span>
        </div>
      </div>
    </div>

    <!-- Timeline Slider -->
    <div class="timeline-container">
      <div class="timeline-header">
        <h3>â±ï¸ Zaman Ã‡izelgesi</h3>
        <div class="timeline-info">
          <span class="current-period" id="current-period">2024 Q4</span>
          <span class="prediction-period" id="prediction-period">â†’ 2025 Q1 (Tahmin)</span>
        </div>
      </div>
      
      <div class="timeline-slider">
        <input type="range" id="time-slider" min="0" max="20" value="15" step="1" />
        <div class="timeline-labels" id="timeline-labels"></div>
      </div>
      
      <div class="timeline-controls">
        <button class="timeline-btn" id="play-btn">â–¶ï¸ Oynat</button>
        <button class="timeline-btn" id="stop-btn">â¹ï¸ Durdur</button>
        <button class="timeline-btn" id="reset-btn">ğŸ”„ SÄ±fÄ±rla</button>
        <div class="playback-speed">
          <label>HÄ±z:</label>
          <select id="speed-select">
            <option value="2000">YavaÅŸ</option>
            <option value="1000" selected>Normal</option>
            <option value="500">HÄ±zlÄ±</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Ä°statistik KartlarÄ± -->
    <div class="stats-container">
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸŒ³</div>
        <div class="stat-content">
          <div class="stat-label">YeÅŸil Alan</div>
          <div class="stat-value">
            <span id="stat-green-current">32.5%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-green-predicted" class="predicted">31.8%</span>
          </div>
          <div class="stat-change negative" id="stat-green-change">-0.7%</div>
        </div>
      </div>
      
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸ¢</div>
        <div class="stat-content">
          <div class="stat-label">Beton Alan</div>
          <div class="stat-value">
            <span id="stat-gray-current">60.2%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-gray-predicted" class="predicted">61.1%</span>
          </div>
          <div class="stat-change positive" id="stat-gray-change">+0.9%</div>
        </div>
      </div>
      
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸ’§</div>
        <div class="stat-content">
          <div class="stat-label">Su KaynaklarÄ±</div>
          <div class="stat-value">
            <span id="stat-water-current">7.3%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-water-predicted" class="predicted">7.1%</span>
          </div>
          <div class="stat-change negative" id="stat-water-change">-0.2%</div>
        </div>
      </div>
    </div>

    <!-- Bilgi Notu -->
    <div class="info-box">
      <div class="info-icon">â„¹ï¸</div>
      <div class="info-content">
        <strong>Model HakkÄ±nda:</strong> Bu tahminler, 2018-2024 arasÄ± Sentinel-2 uydu gÃ¶rÃ¼ntÃ¼leri kullanÄ±larak
        eÄŸitilmiÅŸ UNET (segmentasyon) ve Conv3D (temporal prediction) derin Ã¶ÄŸrenme modelleriyle Ã¼retilmiÅŸtir.
        Model, son 8 Ã§eyrek dÃ¶nemi (2 yÄ±l) kullanarak bir sonraki Ã§eyrek tahmini yapmaktadÄ±r.
        Ortalama doÄŸruluk: <strong>~94%</strong> (Pixel Accuracy), <strong>~91%</strong> (mIoU).
      </div>
    </div>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ============================================================================
// KÄ°MLÄ°K DOÄRULAMA
// ============================================================================
const token = localStorage.getItem('token');
if (!token) {
  location.href = '/';
}

async function whoami() {
  try {
    const response = await fetch('/me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!response.ok) {
      localStorage.removeItem('token');
      location.href = '/';
      return;
    }
    const user = await response.json();
    document.getElementById('who').textContent = user.email;
  } catch (error) {
    console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', error);
    location.href = '/';
  }
}

whoami();

document.getElementById('logout').onclick = () => {
  localStorage.removeItem('token');
  location.href = '/';
};

// ============================================================================
// GLOBAL DEÄÄ°ÅKENLER
// ============================================================================
let predictionData = null; // API'den gelen tÃ¼m tahmin dizisi
let currentIndex = 0; // Slider'daki aktif yÄ±l
let overlayLayer = null; // Harita overlay katmanÄ±

// ============================================================================
// VERÄ° YÃœKLEME
// ============================================================================
async function loadPredictionData() {
  try {
    const response = await fetch('/api/trend/predict', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!response.ok) {
      throw new Error('Tahmin verisi yÃ¼klenemedi');
    }
    const data = await response.json();
    predictionData = data;
    // Slider'Ä± API'den gelen yÄ±llara gÃ¶re ayarla
    const years = data.years;
    const slider = document.getElementById('time-slider');
    slider.min = 0;
    slider.max = years.length - 1;
    slider.value = years.length - 1;
    currentIndex = years.length - 1;
    updateUI();
    console.log('Tahmin verisi yÃ¼klendi:', predictionData);
  } catch (error) {
    console.error('Tahmin yÃ¼kleme hatasÄ±:', error);
    showErrorMessage('Tahmin verisi yÃ¼klenemedi. LÃ¼tfen modellerin yÃ¼klendiÄŸinden emin olun.');
  }
}

function updateUI() {
  if (!predictionData) return;
  const idx = currentIndex;
  const pred = predictionData.predictions[idx];
  // DÃ¶nem bilgilerini gÃ¼ncelle
  document.getElementById('current-period').textContent = pred.current.timeframe;
  document.getElementById('prediction-period').textContent = `â†’ ${pred.prediction.timeframe} (Tahmin)`;
  // Ä°statistik kartlarÄ±nÄ± gÃ¼ncelle
  updateStatCard('green', pred.current.green, pred.prediction.green, pred.changes.green);
  updateStatCard('gray', pred.current.grey, pred.prediction.grey, pred.changes.grey);
  updateStatCard('water', pred.current.water, pred.prediction.water, pred.changes.water);
  // Haritaya overlay ekle
  addPredictionOverlay(pred);
}

function updateStatCard(type, current, predicted, change) {
  const currentEl = document.getElementById(`stat-${type}-current`);
  const predictedEl = document.getElementById(`stat-${type}-predicted`);
  const changeEl = document.getElementById(`stat-${type}-change`);
  
  if (currentEl) currentEl.textContent = `${current.toFixed(1)}%`;
  if (predictedEl) predictedEl.textContent = `${predicted.toFixed(1)}%`;
  
  if (changeEl) {
    const sign = change >= 0 ? '+' : '';
    changeEl.textContent = `${sign}${change.toFixed(1)}%`;
    changeEl.className = 'stat-change ' + (change >= 0 ? 'positive' : 'negative');
  }
}

function addPredictionOverlay(pred) {
  // Ã–nce eski overlay'leri kaldÄ±r
  if (window.overlayLayers && Array.isArray(window.overlayLayers)) {
    window.overlayLayers.forEach(l => map.removeLayer(l));
  }
  window.overlayLayers = [];
  const bounds = [[40.8, 28.6], [41.4, 29.4]];
  if (pred && pred.current_softmax) {
    const arr = pred.current_softmax;
    const h = arr[1].length;
    const w = arr[1][0].length;
    // Katman renk ve indexleri
    const channels = [
      {name: 'green', idx: 1, color: [32, 255, 80]},   // YeÅŸil
      {name: 'gray', idx: 2, color: [120, 120, 120]},  // Beton
      {name: 'water', idx: 3, color: [30, 144, 255]}   // Su
    ];
    // SeÃ§ili katman sayÄ±sÄ±na gÃ¶re opaklÄ±k ayarla
    const selected = channels.filter(ch => visibleLayers[ch.name]);
    let overlayOpacity = 0.7;
    if (selected.length > 1) overlayOpacity = 0.35;
    if (selected.length > 2) overlayOpacity = 0.25;
    if (selected.length === 0) overlayOpacity = 0;
    channels.forEach(ch => {
      if (!visibleLayers[ch.name]) return;
      const channel = arr[ch.idx];
      const imageData = new Uint8ClampedArray(w * h * 4);
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const v = Math.max(0, Math.min(1, channel[y][x]));
          const idx = (y * w + x) * 4;
          imageData[idx] = ch.color[0];
          imageData[idx+1] = ch.color[1];
          imageData[idx+2] = ch.color[2];
          imageData[idx+3] = Math.round(180 * v + 60); // Daha belirgin opaklÄ±k
        }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      const img = ctx.createImageData(w, h);
      img.data.set(imageData);
      ctx.putImageData(img, 0, 0);
      const dataUrl = canvas.toDataURL('image/png');
      const layer = L.imageOverlay(dataUrl, bounds, {opacity: (opacitySlider.value/100)*overlayOpacity});
      layer.addTo(map);
      window.overlayLayers.push(layer);
    });
    // Popup sadece yeÅŸil iÃ§in gÃ¶sterilsin (Ã¶rnek)
    if (window.overlayLayers[0]) {
      window.overlayLayers[0].bindPopup(`
        <div style="font-family: system-ui; padding: 8px;">
          <strong>ğŸ”® ${pred.prediction.timeframe} Tahmini (Softmax)</strong><br/>
          <div style="margin-top: 8px; font-size: 13px;">
            ğŸŒ³ YeÅŸil: ${pred.prediction.green.toFixed(1)}%<br/>
            ğŸ¢ Beton: ${pred.prediction.grey.toFixed(1)}%<br/>
            ğŸ’§ Su: ${pred.prediction.water.toFixed(1)}%
          </div>
        </div>
      `);
    }
  } else {
    const rect = L.rectangle(bounds, {
      color: '#10b981',
      weight: 3,
      fillOpacity: 0.1,
      dashArray: '10, 5'
    }).addTo(map);
    window.overlayLayers.push(rect);
  }
// FAZLADAN KAPATMA PARANTEZÄ° SÄ°LÄ°NDÄ°
}

function showErrorMessage(message) {
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    z-index: 9999;
    font-weight: 600;
    max-width: 400px;
  `;
  errorDiv.textContent = 'âš ï¸ ' + message;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    errorDiv.remove();
  }, 5000);
}

// ============================================================================
// HARÄ°TA BAÅLATMA
// ============================================================================
const map = L.map('map').setView([41.0082, 28.9784], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// KarÅŸÄ±laÅŸtÄ±rma haritasÄ± (baÅŸlangÄ±Ã§ta gizli)
let mapCompare = null;

// ============================================================================
// MOD DEÄÄ°ÅTÄ°RME
// ============================================================================
const modeButtons = document.querySelectorAll('.mode-btn');
const mapElement = document.getElementById('map');
const mapCompareElement = document.getElementById('map-compare');

modeButtons.forEach(btn => {
  btn.onclick = () => {
    modeButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const mode = btn.dataset.mode;
    
    if (mode === 'comparison') {
      // KarÅŸÄ±laÅŸtÄ±rma modu: iki harita yan yana
      mapElement.classList.add('map-split');
      mapCompareElement.classList.remove('map-hidden');
      mapCompareElement.classList.add('map-split');
      
      // Ä°kinci haritayÄ± baÅŸlat (henÃ¼z baÅŸlatÄ±lmamÄ±ÅŸsa)
      if (!mapCompare) {
        mapCompare = L.map('map-compare').setView([41.0082, 28.9784], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(mapCompare);
      }
      
      // Harita boyutlarÄ±nÄ± gÃ¼ncelle
      setTimeout(() => {
        map.invalidateSize();
        mapCompare.invalidateSize();
      }, 100);
      
    } else {
      // Tek harita modu
      mapElement.classList.remove('map-split');
      mapCompareElement.classList.add('map-hidden');
      mapCompareElement.classList.remove('map-split');
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }
  };
});

// ============================================================================
// OPACITY KONTROLÃœ
// ============================================================================
const opacitySlider = document.getElementById('opacity-slider');
const opacityValue = document.getElementById('opacity-value');

opacitySlider.oninput = () => {
  opacityValue.textContent = opacitySlider.value + '%';
  
  // Overlay opacity'yi gÃ¼ncelle
  if (overlayLayer) {
    const opacity = opacitySlider.value / 100;
    overlayLayer.setStyle({ fillOpacity: opacity * 0.5 });
  }
};

// ============================================================================
// LAYER TOGGLE
// ============================================================================
const layerToggles = {
  green: document.getElementById('layer-green'),
  gray: document.getElementById('layer-gray'),
  water: document.getElementById('layer-water')
};

// Layer gÃ¶rÃ¼nÃ¼rlÃ¼k durumlarÄ±
let visibleLayers = { green: true, gray: true, water: true };

Object.keys(layerToggles).forEach(layerName => {
  layerToggles[layerName].onchange = (e) => {
    visibleLayers[layerName] = e.target.checked;
    updateUI(); // Katman deÄŸiÅŸince overlay gÃ¼ncellensin
    console.log(`Layer ${layerName}: ${visibleLayers[layerName] ? 'visible' : 'hidden'}`);
  };
});

// ============================================================================
// TIMELINE KONTROLÃœ
// ============================================================================
const timeSlider = document.getElementById('time-slider');
const currentPeriod = document.getElementById('current-period');
const predictionPeriod = document.getElementById('prediction-period');
const timelineLabels = document.getElementById('timeline-labels');

// Slider input ile ilgili yÄ±lÄ±n tahminini gÃ¶ster
timeSlider.oninput = () => {
  currentIndex = parseInt(timeSlider.value);
  updateUI();
  // Label gÃ¼ncellemesi
  if (predictionData && predictionData.years) {
    currentPeriod.textContent = predictionData.predictions[currentIndex].current.timeframe;
    predictionPeriod.textContent = `â†’ ${predictionData.predictions[currentIndex].prediction.timeframe} (Tahmin)`;
  }
  console.log(`Timeline deÄŸiÅŸti: ${currentIndex}`);
};

// ============================================================================
// PLAYBACK KONTROLÃœ
// ============================================================================
let playbackInterval = null;
const playBtn = document.getElementById('play-btn');
const stopBtn = document.getElementById('stop-btn');
const resetBtn = document.getElementById('reset-btn');
const speedSelect = document.getElementById('speed-select');

playBtn.onclick = () => {
  if (playbackInterval) return; // Zaten oynatÄ±lÄ±yor
  
  const speed = parseInt(speedSelect.value);
  playbackInterval = setInterval(() => {
    let current = parseInt(timeSlider.value);
    if (current < parseInt(timeSlider.max)) {
      timeSlider.value = current + 1;
      timeSlider.oninput();
    } else {
      stopBtn.click();
    }
  }, speed);
  
  playBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  if (playbackInterval) {
    clearInterval(playbackInterval);
    playbackInterval = null;
  }
  playBtn.disabled = false;
  stopBtn.disabled = true;
};

resetBtn.onclick = () => {
  stopBtn.click();
  timeSlider.value = 0;
  timeSlider.oninput();
};

// ============================================================================
// SIDEBAR AÃ‡/KAPA
// ============================================================================
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('.main');
let isCollapsed = false;

sidebarToggle.onclick = () => {
  isCollapsed = !isCollapsed;
  sidebar.classList.toggle('collapsed', isCollapsed);
  if (mainContent) {
    mainContent.classList.toggle('sidebar-collapsed', isCollapsed);
  }
  sidebarToggle.textContent = isCollapsed ? 'â˜°' : 'âœ•';
  sidebarToggle.title = isCollapsed ? 'Sidebar AÃ§' : 'Sidebar Kapat';
  
  // Harita boyutlarÄ±nÄ± gÃ¼ncelle
  setTimeout(() => {
    map.invalidateSize();
    if (mapCompare) mapCompare.invalidateSize();
  }, 300);
};

// ============================================================================
// SIDEBAR GENÄ°ÅLÄ°K AYARI
// ============================================================================
const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;
let startX = 0;
let startWidth = 0;

resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startWidth = sidebar.offsetWidth;
  resizer.classList.add('resizing');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const diff = e.clientX - startX;
  const newWidth = Math.max(250, Math.min(600, startWidth + diff));
  sidebar.style.width = newWidth + 'px';
});

document.addEventListener('mouseup', () => {
  if (!isResizing) return;
  isResizing = false;
  resizer.classList.remove('resizing');
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
  
  setTimeout(() => {
    map.invalidateSize();
    if (mapCompare) mapCompare.invalidateSize();
  }, 100);
});

// BaÅŸlangÄ±Ã§ ayarÄ±
timeSlider.oninput();

// ============================================================================
// SAYFA YÃœKLENDÄ°ÄÄ°NDE VERÄ° YÃœKLE
// ============================================================================
loadPredictionData();
</script>
</body>
</html>
