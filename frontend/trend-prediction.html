<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="icon" type="image/png" href="../images/favicon.png"/>
<title>Trend Tahmini â€” Grey vs Green Atlas</title>

<!-- 
  ============================================================================
  GREY VS GREEN ATLAS - TREND TAHMÄ°NÄ°
  ============================================================================
  
  AÃ§Ä±klama:
    UNET + Conv3D temporal modeli kullanarak gelecek dÃ¶nem (t+1) tahminleri.
    Ä°stanbul iÃ§in yeÅŸil alan, beton ve su kaynaklarÄ±nÄ±n trend analizi.
  
  Ã–zellikler:
    - Ä°nteraktif harita (Leaflet)
    - Zaman Ã§izelgesi slider'Ä±
    - KarÅŸÄ±laÅŸtÄ±rma modu (split-screen)
    - Tahmin overlay'leri
    - Ä°statistik paneli
  
  Model:
    - UNET: 4-class segmentation (background, green, gray, water)
    - Conv3D: Temporal prediction (8 quarters â†’ t+1)
  
  ============================================================================
-->

<!-- Ortak CSS -->
<link rel="stylesheet" href="/css/common.css">
<!-- Trend Prediction CSS -->
<link rel="stylesheet" href="/css/trend-prediction.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  .map-outer {
    position: relative;
    width: 100%;
    height: 60vh;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #map {
    min-height: 400px;
    height: 100%;
    width: 100%;
    background: #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    margin-bottom: 24px;
  }
  #loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.85);
    z-index: 999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }
  .loading-spinner {
    font-size: 48px;
    animation: spin 1s linear infinite;
    color: #10b981;
    margin-bottom: 12px;
  }
  .loading-text {
    font-size: 18px;
    font-weight: 700;
    color: #059669;
    letter-spacing: 0.5px;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

</head>
<body>
<!-- Top Bar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="sidebar-toggle" id="sidebar-toggle" title="Sidebar AÃ§/Kapat">â˜°</button>
    <div class="topbar-brand" style="cursor:default">ğŸŒ Grey vs Green Atlas</div>
    <div class="topbar-search">
      <input type="text" placeholder="Åehir veya analiz ara..."/>
    </div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn">ğŸ”” <span>3</span></button>
    <div class="topbar-user">
      <span>ğŸ‘¤</span>
      <span id="who">YÃ¼kleniyor...</span>
    </div>
    <button class="topbar-logout" id="logout">
      <span>ğŸšª</span>
      <span>Ã‡Ä±kÄ±ÅŸ</span>
    </button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-resizer" id="sidebar-resizer"></div>
    <!-- Ana MenÃ¼ -->
    <div class="sidebar-section">
      <div class="sidebar-title">Ana MenÃ¼</div>
      <nav class="nav">
        <a href="/dashboard.html" id="nav-dashboard">
          <span>ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/map.html" id="nav-map">
          <span>ğŸ—ºï¸</span>
          <span>Harita</span>
        </a>
        <a href="/istanbul-detail.html" id="nav-istanbul">
          <span>ğŸ”¬</span>
          <span>Ä°stanbul Detay</span>
        </a>
        <a href="/trend-prediction.html" id="nav-trend" class="active">
          <span>ğŸ“ˆ</span>
          <span>Trend Tahmini</span>
        </a>
      </nav>
    </div>
    
    <!-- Veri YÃ¶netimi -->
    <div class="sidebar-section">
      <div class="sidebar-title">Veri YÃ¶netimi</div>
      <nav class="nav">
        <a href="/data-sources.html" id="nav-data-sources">
          <span>ğŸ›°ï¸</span>
          <span>Veri KaynaklarÄ±</span>
        </a>
        <a href="/data-upload.html" id="nav-data-upload">
          <span>ğŸ“¤</span>
          <span>Veri Setleri</span>
        </a>
        <a href="/reports.html" id="nav-reports">
          <span>ğŸ§¾</span>
          <span>Raporlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Sistem -->
    <div class="sidebar-section">
      <div class="sidebar-title">Sistem</div>
      <nav class="nav">
        <a href="/settings.html" id="nav-settings">
          <span>âš™ï¸</span>
          <span>Ayarlar</span>
        </a>
      </nav>
    </div>
    
    <!-- Model Bilgisi -->
    <div class="sidebar-footer">
      <div class="sidebar-title">Model Bilgisi</div>
      <div class="sidebar-stats">
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Model</span>
          <span class="sidebar-stat-value">UNET+Conv3D</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">Sequence</span>
          <span class="sidebar-stat-value">8 Quarters</span>
        </div>
        <div class="sidebar-stat">
          <span class="sidebar-stat-label">DoÄŸruluk</span>
          <span class="sidebar-stat-value">~94%</span>
        </div>
      </div>
    </div>
  </aside>
  
  <main class="main">
    <div class="header">
      <h1>Ä°stanbul Trend Tahmini</h1>
      <p>Yapay zeka ile gelecek dÃ¶nem yeÅŸil alan, beton ve su kaynaklarÄ±nÄ±n tahmini</p>
    </div>

    <!-- Kontrol Paneli -->
    <div class="control-panel" aria-label="Harita ve Overlay Kontrolleri">
      <div class="control-group">
        <label for="mode-prediction">ğŸ“… GÃ¶rÃ¼ntÃ¼leme Modu</label>
        <div class="mode-buttons" role="group" aria-label="GÃ¶rÃ¼ntÃ¼leme Modu">
          <button class="mode-btn active" id="mode-prediction" data-mode="prediction" aria-pressed="true">Tahmin</button>
          <button class="mode-btn" id="mode-comparison" data-mode="comparison" aria-pressed="false">KarÅŸÄ±laÅŸtÄ±rma</button>
          <button class="mode-btn" id="mode-difference" data-mode="difference" aria-pressed="false">Fark Analizi</button>
        </div>
      </div>
      <div class="control-group">
        <label for="opacity-slider">ğŸ¨ Overlay ÅeffaflÄ±k</label>
        <input type="range" id="opacity-slider" min="0" max="100" value="70" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" />
        <span id="opacity-value">70%</span>
      </div>
      <div class="control-group">
        <label>ğŸ” Katman SeÃ§imi</label>
        <div class="layer-checkboxes" role="group" aria-label="Katman SeÃ§imi">
          <label><input type="checkbox" id="layer-green" checked aria-checked="true" /> ğŸŒ³ YeÅŸil Alan</label>
          <label><input type="checkbox" id="layer-gray" checked aria-checked="true" /> ğŸ¢ Beton</label>
          <label><input type="checkbox" id="layer-water" checked aria-checked="true" /> ğŸ’§ Su</label>
        </div>
      </div>
    </div>

    <!-- Harita Konteyneri -->
    <div class="map-container">
      <div class="map-outer">
        <div id="map" class="map" aria-label="Tahmin HaritasÄ±"></div>
        <canvas id="mask-canvas" width="256" height="256" style="position:absolute;top:0;left:0;z-index:500;pointer-events:none;display:none;"></canvas>
        <!-- Loading animasyonu -->
        <div id="loading-overlay">
          <div class="loading-spinner">â³</div>
          <div class="loading-text">Harita yÃ¼kleniyor...</div>
        </div>
      </div>
      <!-- KarÅŸÄ±laÅŸtÄ±rma Modu iÃ§in Ä°kinci Harita -->
      <div id="map-compare" class="map map-hidden" aria-label="KarÅŸÄ±laÅŸtÄ±rma HaritasÄ±"></div>
      <!-- Legend -->
      <div class="map-legend" aria-label="SÄ±nÄ±f Renkleri">
        <div class="legend-title">SÄ±nÄ±flandÄ±rma</div>
        <div class="legend-item">
          <span class="legend-color" style="background: #10b981;"></span>
          <span>YeÅŸil Alan</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #6b7280;"></span>
          <span>Beton</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #3b82f6;"></span>
          <span>Su KaynaklarÄ±</span>
        </div>
        <div class="legend-item">
          <span class="legend-color" style="background: #000000;"></span>
          <span>Arka Plan</span>
        </div>
      </div>
    </div>

    <!-- Timeline Slider -->
    <div class="timeline-container">
      <div class="timeline-header">
        <h3>â±ï¸ Zaman Ã‡izelgesi</h3>
        <div class="timeline-info">
          <span class="current-period" id="current-period">2024 Q4</span>
          <span class="prediction-period" id="prediction-period">â†’ 2025 Q1 (Tahmin)</span>
        </div>
      </div>
      
      <div class="timeline-slider">
        <input type="range" id="time-slider" min="0" max="20" value="15" step="1" aria-valuenow="15" aria-valuemin="0" aria-valuemax="20" />
        <div class="timeline-labels" id="timeline-labels" aria-label="Zaman Dilimleri"></div>
      </div>
      
      <div class="timeline-controls">
        <button class="timeline-btn" id="play-btn">â–¶ï¸ Oynat</button>
        <button class="timeline-btn" id="stop-btn">â¹ï¸ Durdur</button>
        <button class="timeline-btn" id="reset-btn">ğŸ”„ SÄ±fÄ±rla</button>
        <div class="playback-speed">
          <label>HÄ±z:</label>
          <select id="speed-select">
            <option value="2000">YavaÅŸ</option>
            <option value="1000" selected>Normal</option>
            <option value="500">HÄ±zlÄ±</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Trend Chart -->
    <!-- Folium Harita ve Ä°ndirme Butonu AlanÄ± -->
    <div id="folium-map-section" style="margin:32px 0 0 0; display:flex; flex-direction:column; align-items:center;">
  <div id="folium-map-container" style="width:100%; min-height:600px; max-width:1400px; border-radius:12px; box-shadow:0 2px 16px rgba(0,0,0,0.08); background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
        <!-- Burada folium haritasÄ± gÃ¶sterilecek -->
        <span style="color:#6b7280;">Tahmin haritasÄ± burada gÃ¶rÃ¼necek</span>
      </div>
  <!-- Ä°ndirme butonu kaldÄ±rÄ±ldÄ± -->
    </div>

    <!-- Ä°statistik KartlarÄ± -->
    <div class="stats-container">
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸŒ³</div>
        <div class="stat-content">
          <div class="stat-label">YeÅŸil Alan</div>
          <div class="stat-value">
            <span id="stat-green-current">32.5%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-green-predicted" class="predicted">31.8%</span>
          </div>
          <div class="stat-change negative" id="stat-green-change">-0.7%</div>
        </div>
      </div>
      
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸ¢</div>
        <div class="stat-content">
          <div class="stat-label">Beton Alan</div>
          <div class="stat-value">
            <span id="stat-gray-current">60.2%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-gray-predicted" class="predicted">61.1%</span>
          </div>
          <div class="stat-change positive" id="stat-gray-change">+0.9%</div>
        </div>
      </div>
      
      <div class="stat-card-trend">
        <div class="stat-icon">ğŸ’§</div>
        <div class="stat-content">
          <div class="stat-label">Su KaynaklarÄ±</div>
          <div class="stat-value">
            <span id="stat-water-current">7.3%</span>
            <span class="stat-arrow">â†’</span>
            <span id="stat-water-predicted" class="predicted">7.1%</span>
          </div>
          <div class="stat-change negative" id="stat-water-change">-0.2%</div>
        </div>
      </div>
    </div>

    <!-- Bilgi Notu -->
    <div class="info-box">
      <div class="info-icon">â„¹ï¸</div>
      <div class="info-content">
        <strong>Model HakkÄ±nda:</strong> Bu tahminler, 2018-2024 arasÄ± Sentinel-2 uydu gÃ¶rÃ¼ntÃ¼leri kullanÄ±larak
        eÄŸitilmiÅŸ UNET (segmentasyon) ve Conv3D (temporal prediction) derin Ã¶ÄŸrenme modelleriyle Ã¼retilmiÅŸtir.
        Model, son 8 Ã§eyrek dÃ¶nemi (2 yÄ±l) kullanarak bir sonraki Ã§eyrek tahmini yapmaktadÄ±r.
        Ortalama doÄŸruluk: <strong>~94%</strong> (Pixel Accuracy), <strong>~91%</strong> (mIoU).
      </div>
    </div>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Loading overlay kontrolÃ¼
function showLoading(show) {
  const overlay = document.getElementById('loading-overlay');
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
}
// ============================================================================
// KÄ°MLÄ°K DOÄRULAMA
// ============================================================================
const token = localStorage.getItem('token');
if (!token) {
  location.href = '/';
}

async function whoami() {
  try {
    const response = await fetch('/me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!response.ok) {
      localStorage.removeItem('token');
      location.href = '/';
      return;
    }
    const user = await response.json();
    document.getElementById('who').textContent = user.email;
  } catch (error) {
    console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', error);
    location.href = '/';
  }
}

whoami();

document.getElementById('logout').onclick = () => {
  localStorage.removeItem('token');
  location.href = '/';
};

// ============================================================================
// GLOBAL DEÄÄ°ÅKENLER
// ============================================================================
let predictionData = null; // API'den gelen tÃ¼m tahmin dizisi
let currentIndex = 0; // Slider'daki aktif yÄ±l
let overlayLayer = null; // Harita overlay katmanÄ±

// ============================================================================
// VERÄ° YÃœKLEME
// ============================================================================
async function loadPredictionData() {
  showLoading(true);
  try {
    const response = await fetch('/api/trend/predict', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!response.ok) {
      throw new Error('Tahmin verisi yÃ¼klenemedi');
    }
    const data = await response.json();
    predictionData = data;
    // Slider'Ä± API'den gelen yÄ±llara gÃ¶re ayarla
    const years = data.years;
    const slider = document.getElementById('time-slider');
    slider.min = 0;
    slider.max = years.length - 1;
    slider.value = years.length - 1;
    currentIndex = years.length - 1;
    updateTimelineLabels(years);
    updateUI();
    createTrendChart();
    console.log('Tahmin verisi yÃ¼klendi:', predictionData);
  } catch (error) {
    console.error('Tahmin yÃ¼kleme hatasÄ±:', error);
    showErrorMessage('Tahmin verisi yÃ¼klenemedi. LÃ¼tfen modellerin yÃ¼klendiÄŸinden emin olun.');
    // Hata olsa da harita gÃ¶rÃ¼nÃ¼r kalsÄ±n, loading overlay'i kapat
    showLoading(false);
  } finally {
    // Sadece baÅŸarÄ±lÄ± yÃ¼klemede deÄŸil, her durumda loading overlay'i kapat
    showLoading(false);
  }
}

// Trend Chart.js fonksiyonu
let trendChartInstance = null;
function createTrendChart() {
  const chartEl = document.getElementById('trendChart');
  if (!chartEl || !predictionData || !predictionData.predictions) return;

  // X ekseni: dÃ¶nemler
  const labels = predictionData.predictions.map(p => p.prediction.timeframe);
  // Y ekseni: yeÅŸil, beton, su oranlarÄ±
  const green = predictionData.predictions.map(p => p.prediction.green);
  const grey = predictionData.predictions.map(p => p.prediction.grey);
  const water = predictionData.predictions.map(p => p.prediction.water);

  if (trendChartInstance) {
    trendChartInstance.destroy();
  }
  trendChartInstance = new Chart(chartEl.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'ğŸŒ³ YeÅŸil Alan',
          data: green,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16,185,129,0.15)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'ğŸ¢ Beton',
          data: grey,
          borderColor: '#9ca3af',
          backgroundColor: 'rgba(156,163,175,0.15)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        },
        {
          label: 'ğŸ’§ Su',
          data: water,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.15)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true },
        title: { display: false }
      },
      scales: {
        y: { beginAtZero: true, max: 100, title: { display: true, text: '%' } }
      }
    }
  });
}

// Timeline label'larÄ±nÄ± doldur
function updateTimelineLabels(years) {
  const labelsDiv = document.getElementById('timeline-labels');
  if (!labelsDiv || !years) return;
  labelsDiv.innerHTML = '';
  const slider = document.getElementById('time-slider');
  const sliderWidth = slider.offsetWidth || 600;
  years.forEach((y, i) => {
    const label = document.createElement('div');
    label.className = 'timeline-label' + (i === currentIndex ? ' active' : '');
    label.textContent = y;
    label.style.left = ((i / (years.length - 1)) * 100) + '%';
    labelsDiv.appendChild(label);
  });
}

function updateUI() {
  if (!predictionData) return;
  const idx = currentIndex;
  const pred = predictionData.predictions[idx];
  // DÃ¶nem bilgilerini gÃ¼ncelle
  document.getElementById('current-period').textContent = pred.current.timeframe;
  document.getElementById('prediction-period').textContent = `â†’ ${pred.prediction.timeframe} (Tahmin)`;
  // Ä°statistik kartlarÄ±nÄ± gÃ¼ncelle
  updateStatCard('green', pred.current.green, pred.prediction.green, pred.changes.green);
  updateStatCard('gray', pred.current.grey, pred.prediction.grey, pred.changes.grey);
  updateStatCard('water', pred.current.water, pred.prediction.water, pred.changes.water);
  // Haritaya overlay ekle (isteÄŸe baÄŸlÄ±, sadece mask varsa)
  addPredictionOverlay(pred);

  // --- TREND TILE LAYER ENTEGRASYONU ---
  // YÄ±l ve Ã§eyrek predictionData'dan alÄ±nÄ±r
  const year = pred.prediction.year || pred.current.year;
  const quarter = pred.prediction.quarter || pred.current.quarter;

  // Eski trend tile layer'Ä± kaldÄ±r
  if (window.trendTileLayer) {
    map.removeLayer(window.trendTileLayer);
    window.trendTileLayer = null;
  }

  // Yeni trend tile layer'Ä± ekle
  window.trendTileLayer = L.tileLayer(`/api/trend/tiles/${year}/${quarter}/{z}/{x}/{y}.png`, {
    attribution: 'Trend Prediction',
    opacity: parseFloat(opacitySlider.value) / 100,
    maxZoom: 18,
    tileSize: 256
  });
  window.trendTileLayer.addTo(map);
}

function updateStatCard(type, current, predicted, change) {
  const currentEl = document.getElementById(`stat-${type}-current`);
  const predictedEl = document.getElementById(`stat-${type}-predicted`);
  const changeEl = document.getElementById(`stat-${type}-change`);
  
  if (currentEl) currentEl.textContent = `${current.toFixed(1)}%`;
  if (predictedEl) predictedEl.textContent = `${predicted.toFixed(1)}%`;
  
  if (changeEl) {
    const sign = change >= 0 ? '+' : '';
    changeEl.textContent = `${sign}${change.toFixed(1)}%`;
    changeEl.className = 'stat-change ' + (change >= 0 ? 'positive' : 'negative');
  }
}

function addPredictionOverlay(pred) {
  // Ã–nce eski overlay'leri kaldÄ±r
  if (window.overlayLayers && Array.isArray(window.overlayLayers)) {
    window.overlayLayers.forEach(l => map.removeLayer(l));
  }
  window.overlayLayers = [];
  // Sadece Ä°stanbul tahmini iÃ§in overlay
  if (window.overlayLayers && Array.isArray(window.overlayLayers)) {
    window.overlayLayers.forEach(l => map.removeLayer(l));
  }
  window.overlayLayers = [];
  if (pred && pred.class_mask) {
    const mask = pred.class_mask;
    // Sabit boyut: 256x256
    const w = 256;
    const h = 256;
    // Mask boyutu farklÄ±ysa yeniden boyutlandÄ±r (gerekirse)
    // (Burada varsayÄ±lan olarak mask[x][y] varsa kullanÄ±lÄ±r)
    // Renkler: 0-bg, 1-yeÅŸil, 2-gri, 3-mavi
    const colors = {
      0: [0,0,0,0],        // background: ÅŸeffaf
      1: [16,185,129,220], // green: #10b981
      2: [128,128,128,220],// gray: #808080
      3: [59,130,246,220]  // water: #3b82f6
    };
    // Canvas oluÅŸtur
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    const imgData = ctx.createImageData(w, h);
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        let cls = 0;
        if (mask[x] && typeof mask[x][y] !== 'undefined') {
          cls = mask[x][y];
        }
        const idx = (y * w + x) * 4;
        const color = colors[cls] || [0,0,0,0];
        imgData.data[idx] = color[0];
        imgData.data[idx+1] = color[1];
        imgData.data[idx+2] = color[2];
        imgData.data[idx+3] = Math.round(color[3] * (opacitySlider.value/100));
      }
    }
    ctx.putImageData(imgData, 0, 0);
    const dataUrl = canvas.toDataURL('image/png');
    // Ä°stanbul iÃ§in bounds
    const bounds = [[40.8, 28.6], [41.4, 29.4]];
    const layer = L.imageOverlay(dataUrl, bounds, {opacity: 0.7});
    layer.addTo(map);
    window.overlayLayers.push(layer);
  }
// FAZLADAN KAPATMA PARANTEZÄ° SÄ°LÄ°NDÄ°
}

function showErrorMessage(message) {
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    z-index: 9999;
    font-weight: 600;
    max-width: 400px;
  `;
  errorDiv.textContent = 'âš ï¸ ' + message;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    errorDiv.remove();
  }, 5000);
}



// --- HARÄ°TA BAÅLATMA VE TREND TILE LAYER ---
window.addEventListener('DOMContentLoaded', () => {
  // Harita container'Ä± tam oturmazsa, boyutunu gÃ¼ncelle
  setTimeout(() => {
    if (window.map) window.map.invalidateSize();
  }, 400);
  const istanbulBounds = [[40.75, 28.62], [41.18, 29.56]];
  window.map = L.map('map', {
    center: [40.965, 29.09],
    zoom: 11,
    minZoom: 10,
    maxZoom: 18,
    zoomControl: true,
    scrollWheelZoom: true,
    doubleClickZoom: false,
    dragging: true,
    zoomSnap: 0.10,
    zoomDelta: 0.5,
    wheelPxPerZoomLevel: 120
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap',
    maxZoom: 18
  }).addTo(window.map);

  window.trendTileLayer = null;
  window.currentTrendYear = 2026;
  window.currentTrendQuarter = 1;
  window.trendOpacity = 0.7;

  window.updateTrendTileLayer = function() {
    if (window.trendTileLayer) {
      window.map.removeLayer(window.trendTileLayer);
    }
    const tileUrl = `/api/trend/tiles/${window.currentTrendYear}/${window.currentTrendQuarter}/{z}/{x}/{y}.png`;
    window.trendTileLayer = L.tileLayer(tileUrl, {
      attribution: 'Trend Prediction',
      minZoom: 12,
      maxZoom: 15,
      opacity: window.trendOpacity,
      tileSize: 256
    });
    window.trendTileLayer.addTo(window.map);
    console.log(`ğŸŸ¢ Trend tile layer updated: ${window.currentTrendYear} Q${window.currentTrendQuarter}`);
  };

  // Opacity slider event
  const opacitySlider = document.getElementById('opacity-slider');
  if (opacitySlider) {
    opacitySlider.addEventListener('input', (e) => {
      window.trendOpacity = e.target.value / 100;
      document.getElementById('opacity-value').textContent = e.target.value + '%';
      if (window.trendTileLayer) {
        window.trendTileLayer.setOpacity(window.trendOpacity);
      }
    });
  }

  // Zoom kontrolÃ¼ - DÃ¼ÅŸÃ¼k zoom'da tile layer'Ä± gizle
  window.map.on('zoomend', () => {
    const currentZoom = window.map.getZoom();
    if (currentZoom < 12 && window.trendTileLayer) {
      window.map.removeLayer(window.trendTileLayer);
      window.trendTileLayer = null;
      console.log('â„¹ï¸ Zoom seviyesi dÃ¼ÅŸÃ¼k - trend tile layer gizlendi');
    } else if (currentZoom >= 12 && !window.trendTileLayer) {
      window.updateTrendTileLayer();
      console.log('âœ… Zoom seviyesi yeterli - trend tile layer gÃ¶steriliyor');
    }
  });

  // BaÅŸlangÄ±Ã§ta trend tile layer'Ä± ekle
  window.updateTrendTileLayer();
});

// KarÅŸÄ±laÅŸtÄ±rma haritasÄ± (baÅŸlangÄ±Ã§ta gizli)
let mapCompare = null;

// ============================================================================
// MOD DEÄÄ°ÅTÄ°RME
// ============================================================================
const modeButtons = document.querySelectorAll('.mode-btn');
const mapElement = document.getElementById('map');
const mapCompareElement = document.getElementById('map-compare');

modeButtons.forEach(btn => {
  btn.onclick = () => {
    modeButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const mode = btn.dataset.mode;
    
    if (mode === 'comparison') {
      // KarÅŸÄ±laÅŸtÄ±rma modu: iki harita yan yana
      mapElement.classList.add('map-split');
      mapCompareElement.classList.remove('map-hidden');
      mapCompareElement.classList.add('map-split');
      
      // Ä°kinci haritayÄ± baÅŸlat (henÃ¼z baÅŸlatÄ±lmamÄ±ÅŸsa)
      if (!mapCompare) {
        mapCompare = L.map('map-compare').setView([41.0082, 28.9784], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(mapCompare);
      }
      
      // Harita boyutlarÄ±nÄ± gÃ¼ncelle
      setTimeout(() => {
        map.invalidateSize();
        mapCompare.invalidateSize();
      }, 100);
      
    } else {
      // Tek harita modu
      mapElement.classList.remove('map-split');
      mapCompareElement.classList.add('map-hidden');
      mapCompareElement.classList.remove('map-split');
      
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }
  };
});

// ============================================================================
// OPACITY KONTROLÃœ
// ============================================================================
const opacitySlider = document.getElementById('opacity-slider');
const opacityValue = document.getElementById('opacity-value');

opacitySlider.oninput = () => {
  opacityValue.textContent = opacitySlider.value + '%';
  
  // Overlay opacity'yi gÃ¼ncelle
  if (overlayLayer) {
    const opacity = opacitySlider.value / 100;
    overlayLayer.setStyle({ fillOpacity: opacity * 0.5 });
  }
};

// ============================================================================
// LAYER TOGGLE
// ============================================================================
const layerToggles = {
  green: document.getElementById('layer-green'),
  gray: document.getElementById('layer-gray'),
  water: document.getElementById('layer-water')
};

// Layer gÃ¶rÃ¼nÃ¼rlÃ¼k durumlarÄ±
let visibleLayers = { green: true, gray: true, water: true };

Object.keys(layerToggles).forEach(layerName => {
  layerToggles[layerName].onchange = (e) => {
    visibleLayers[layerName] = e.target.checked;
    updateUI(); // Katman deÄŸiÅŸince overlay gÃ¼ncellensin
    console.log(`Layer ${layerName}: ${visibleLayers[layerName] ? 'visible' : 'hidden'}`);
  };
});

// ============================================================================
// TIMELINE KONTROLÃœ
// ============================================================================
const timeSlider = document.getElementById('time-slider');
const currentPeriod = document.getElementById('current-period');
const predictionPeriod = document.getElementById('prediction-period');
const timelineLabels = document.getElementById('timeline-labels');

// Slider input ile ilgili yÄ±lÄ±n tahminini gÃ¶ster
timeSlider.oninput = () => {
  currentIndex = parseInt(timeSlider.value);
  updateUI();
  // Label gÃ¼ncellemesi
  if (predictionData && predictionData.years) {
    currentPeriod.textContent = predictionData.predictions[currentIndex].current.timeframe;
    predictionPeriod.textContent = `â†’ ${predictionData.predictions[currentIndex].prediction.timeframe} (Tahmin)`;
  }
  console.log(`Timeline deÄŸiÅŸti: ${currentIndex}`);
};

// ============================================================================
// PLAYBACK KONTROLÃœ
// ============================================================================
let playbackInterval = null;
const playBtn = document.getElementById('play-btn');
const stopBtn = document.getElementById('stop-btn');
const resetBtn = document.getElementById('reset-btn');
const speedSelect = document.getElementById('speed-select');

playBtn.onclick = () => {
  if (playbackInterval) return; // Zaten oynatÄ±lÄ±yor
  
  const speed = parseInt(speedSelect.value);
  playbackInterval = setInterval(() => {
    let current = parseInt(timeSlider.value);
    if (current < parseInt(timeSlider.max)) {
      timeSlider.value = current + 1;
      timeSlider.oninput();
    } else {
      stopBtn.click();
    }
  }, speed);
  
  playBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  if (playbackInterval) {
    clearInterval(playbackInterval);
    playbackInterval = null;
  }
  playBtn.disabled = false;
  stopBtn.disabled = true;
};

resetBtn.onclick = () => {
  stopBtn.click();
  timeSlider.value = 0;
  timeSlider.oninput();
};

// ============================================================================
// SIDEBAR AÃ‡/KAPA
// ============================================================================
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('.main');
let isCollapsed = false;

sidebarToggle.onclick = () => {
  isCollapsed = !isCollapsed;
  sidebar.classList.toggle('collapsed', isCollapsed);
  if (mainContent) {
    mainContent.classList.toggle('sidebar-collapsed', isCollapsed);
  }
  sidebarToggle.textContent = isCollapsed ? 'â˜°' : 'âœ•';
  sidebarToggle.title = isCollapsed ? 'Sidebar AÃ§' : 'Sidebar Kapat';
  
  // Harita boyutlarÄ±nÄ± gÃ¼ncelle
  setTimeout(() => {
    map.invalidateSize();
    if (mapCompare) mapCompare.invalidateSize();
  }, 300);
};

// ============================================================================
// SIDEBAR GENÄ°ÅLÄ°K AYARI
// ============================================================================
const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;
let startX = 0;
let startWidth = 0;

resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startWidth = sidebar.offsetWidth;
  resizer.classList.add('resizing');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const diff = e.clientX - startX;
  const newWidth = Math.max(250, Math.min(600, startWidth + diff));
  sidebar.style.width = newWidth + 'px';
});

document.addEventListener('mouseup', () => {
  if (!isResizing) return;
  isResizing = false;
  resizer.classList.remove('resizing');
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
  
  setTimeout(() => {
    map.invalidateSize();
    if (mapCompare) mapCompare.invalidateSize();
  }, 100);
});

// BaÅŸlangÄ±Ã§ ayarÄ±
timeSlider.oninput();

// ============================================================================
// SAYFA YÃœKLENDÄ°ÄÄ°NDE VERÄ° YÃœKLE
// ============================================================================
loadPredictionData();


// ============================================================================
// FOLIUM HARÄ°TA Ä°NDÄ°RME
// ============================================================================


// --- PNG Mozaik HaritasÄ±nÄ± fetch+blob ile gÃ¶ster ---
async function showMosaicImage() {
  const year = window.currentTrendYear || 2026;
  const quarter = window.currentTrendQuarter || 1;
  const token = localStorage.getItem('token');
  if (!token) {
    alert('GiriÅŸ yapmalÄ±sÄ±nÄ±z!');
    return;
  }
  const pngUrl = `/api/trend/folium_mosaic/${year}/${quarter}/download`;
  const foliumContainer = document.getElementById('folium-map-container');
  if (foliumContainer) {
    foliumContainer.innerHTML = '';
    try {
      const resp = await fetch(pngUrl, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!resp.ok) throw new Error('PNG mozaik haritasÄ± alÄ±namadÄ±');
      const blob = await resp.blob();
      const imgUrl = URL.createObjectURL(blob);
      const img = document.createElement('img');
      img.src = imgUrl;
      img.alt = 'Tahmin Mozaik HaritasÄ±';
      img.style.maxWidth = '100%';
      img.style.borderRadius = '12px';
      img.style.boxShadow = '0 2px 16px rgba(0,0,0,0.08)';
      foliumContainer.appendChild(img);
    } catch (e) {
      foliumContainer.innerHTML = '<span style="color:#ef4444">PNG mozaik haritasÄ± yÃ¼klenemedi</span>';
    }
  }
}

// --- Folium haritasÄ±nÄ± otomatik olarak iframe ile gÃ¶ster ---
async function showFoliumMapIframe() {
  const year = window.currentTrendYear || 2026;
  const quarter = window.currentTrendQuarter || 1;
  const token = localStorage.getItem('token');
  const foliumContainer = document.getElementById('folium-map-container');
  if (foliumContainer) {
    // Folium haritasÄ± endpointi token gerektiriyorsa ekle
    let foliumUrl = `/api/trend/folium_map/${year}/${quarter}`;
    if (token) foliumUrl += `?token=${encodeURIComponent(token)}`;
    foliumContainer.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.src = foliumUrl;
  iframe.style.width = '100%';
  iframe.style.minHeight = '800px';
  iframe.style.height = '800px';
    iframe.style.border = 'none';
    iframe.style.borderRadius = '12px';
    foliumContainer.appendChild(iframe);
  }
}

// --- Sayfa yÃ¼klenince folium haritasÄ±nÄ± otomatik gÃ¶ster ---
window.addEventListener('DOMContentLoaded', () => {
  showFoliumMapIframe();
});

// Ä°ndirme butonu ve fonksiyonu kaldÄ±rÄ±ldÄ±
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</body>
</html>
