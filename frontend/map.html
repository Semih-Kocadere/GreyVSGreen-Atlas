<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Harita â€” Greygreen</title>

<!-- CSS -->
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/map.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
</head>
<body>
<!-- Top Bar -->
<header class="topbar">
  <div class="topbar-left">
    <button class="sidebar-toggle" id="sidebar-toggle" title="Sidebar AÃ§/Kapat">â˜°</button>
    <div class="topbar-brand" onclick="location.href='/dashboard.html'">ğŸŒ Grey vs Green Atlas</div>
  </div>
  <div class="topbar-right">
    <button class="topbar-btn">ğŸ”” <span>3</span></button>
    <div class="topbar-user">
      <span>ğŸ‘¤</span>
      <span id="who">YÃ¼kleniyor...</span>
    </div>
    <button class="topbar-logout" id="logout">
      <span>ğŸšª</span>
      <span>Ã‡Ä±kÄ±ÅŸ</span>
    </button>
  </div>
</header>

<!-- Layout with Sidebar -->
<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-resizer" id="sidebar-resizer"></div>

    <!-- Ana MenÃ¼ -->
    <div class="sidebar-section">
      <div class="sidebar-title">Ana MenÃ¼</div>
      <nav class="nav">
        <a href="/dashboard.html">
          <span>ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="/map.html" class="active">
          <span>ğŸ—ºï¸</span>
          <span>Harita</span>
        </a>
        <a href="/istanbul-detail.html">
          <span>ğŸ”¬</span>
          <span>Ä°stanbul Detay</span>
        </a>
      </nav>
    </div>

    <!-- Veri YÃ¶netimi -->
    <div class="sidebar-section">
      <div class="sidebar-title">Veri YÃ¶netimi</div>
      <nav class="nav">
        <a href="/data-sources.html">
          <span>ğŸ›°ï¸</span>
          <span>Veri KaynaklarÄ±</span>
        </a>
        <a href="/data-upload.html">
          <span>ğŸ“¤</span>
          <span>Veri Setleri</span>
        </a>
        <a href="/reports.html">
          <span>ğŸ§¾</span>
          <span>Raporlar</span>
        </a>
      </nav>
    </div>

    <!-- Sistem -->
    <div class="sidebar-section">
      <div class="sidebar-title">Sistem</div>
      <nav class="nav">
        <a href="/settings.html">
          <span>âš™ï¸</span>
          <span>Ayarlar</span>
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="map-wrapper">
      <div id="loading" class="loading">
        <div class="loading-spinner">ğŸŒ</div>
        <div class="loading-text">Harita YÃ¼kleniyor...</div>
      </div>
      
      <div id="map"></div>
  
  <!-- Right Control Panel -->
  <div class="right-panel" id="right-panel">
    <button class="panel-close" id="panel-close">âœ•</button>
    
    <div class="panel-header">
      <h3>ğŸ›ï¸ Harita Kontrolleri</h3>
    </div>
    
    <!-- GÃ¶rÃ¼ntÃ¼leme DÃ¶nemi -->
    <div class="panel-section">
      <label class="panel-label">ğŸ“… Zaman Dilimi</label>
      <div class="timeframe-buttons">
        <button class="timeframe-btn active" data-time="now">
          <span>ğŸ“ 2024 Q4</span>
          <span class="icon">âœ“</span>
        </button>
        <button class="timeframe-btn" data-time="6m">
          <span>ğŸ“ˆ 2025 Q2</span>
          <span class="icon"></span>
        </button>
        <button class="timeframe-btn" data-time="12m">
          <span>ï¿½ 2025 Q4</span>
          <span class="icon"></span>
        </button>
      </div>
    </div>
    
    <!-- GÃ¶rÃ¼ntÃ¼leme Modu -->
    <div class="panel-section">
      <label class="panel-label">ğŸ“Š GÃ¶rÃ¼nÃ¼m Modu</label>
      <div class="view-mode">
        <button class="view-btn active" data-mode="markers">ğŸ“ Noktalar</button>
        <button class="view-btn" data-mode="heatmap">ğŸ”¥ IsÄ± HaritasÄ±</button>
      </div>
    </div>
    
    <!-- Uydu KatmanÄ± -->
    <div class="panel-section">
      <label class="panel-label">ğŸ›°ï¸ Uydu GÃ¶rÃ¼ntÃ¼sÃ¼</label>
      <div class="view-mode">
        <button class="view-btn" id="satellite-toggle" data-satellite="off" style="width:100%">
          <span>ğŸ—ºï¸ Normal Harita</span>
        </button>
      </div>
    </div>
    
    <!-- Ä°statistikler -->
    <div class="panel-section">
      <label class="panel-label">ğŸ“Š Ä°stanbul Ã–zeti</label>
      <div class="info-stats">
        <div class="info-stat">
          <div class="info-stat-label">ğŸŒ³ YeÅŸil Alan</div>
          <div class="info-stat-value" id="avg-green">-</div>
        </div>
        <div class="info-stat">
          <div class="info-stat-label">ğŸ¢ Beton</div>
          <div class="info-stat-value" id="avg-grey">-</div>
        </div>
        <div class="info-stat">
          <div class="info-stat-label">ğŸ’§ Su</div>
          <div class="info-stat-value" id="avg-water">-</div>
        </div>
      </div>
    </div>
    
    <!-- GÃ¶sterge -->
    <div class="panel-section">
      <label class="panel-label">ğŸ¨ Renk GÃ¶stergesi</label>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color legend-green"></div>
          <span>YeÅŸil Alan</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-grey"></div>
          <span>Beton/Gri Alan</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-water"></div>
          <span>Su KaynaklarÄ±</span>
        </div>
      </div>
    </div>
  </div>
  
  </main>
</div>

<script>
// ============================================================================
// KÄ°MLÄ°K DOÄRULAMA (Authentication)
// ============================================================================

// JWT token'Ä± kontrol et - yoksa login'e yÃ¶nlendir
const token = localStorage.getItem('token');
if (!token) {
  location.href = '/';
}

/**
 * KullanÄ±cÄ± bilgilerini Ã§ek ve topbar'da gÃ¶ster
 * API: GET /me
 */
async function whoami() {
  try {
    const response = await fetch('/me', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (!response.ok) {
      // Token geÃ§ersizse login'e yÃ¶nlendir
      localStorage.removeItem('token');
      location.href = '/';
      return;
    }
    
    const user = await response.json();
    document.getElementById('who').textContent = user.email;
  } catch (error) {
    console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', error);
    location.href = '/';
  }
}

whoami();

/**
 * Ã‡Ä±kÄ±ÅŸ butonu - token'Ä± sil ve login'e yÃ¶nlendir
 */
document.getElementById('logout').onclick = () => {
  localStorage.removeItem('token');
  location.href = '/';
};

/**
 * Sidebar toggle functionality
 */
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebar = document.getElementById('sidebar');
let isCollapsed = true; // Start collapsed on map page

// Initialize sidebar as collapsed
sidebar.classList.add('collapsed');
sidebarToggle.textContent = 'â˜°';

sidebarToggle.onclick = () => {
  isCollapsed = !isCollapsed;
  sidebar.classList.toggle('collapsed', isCollapsed);
  sidebarToggle.textContent = isCollapsed ? 'â˜°' : 'âœ•';
};

/**
 * Sidebar resize functionality
 */
const resizer = document.getElementById('sidebar-resizer');
let isResizing = false;
let startX = 0;
let startWidth = 0;

resizer.addEventListener('mousedown', (e) => {
  isResizing = true;
  startX = e.clientX;
  startWidth = sidebar.offsetWidth;
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
});

document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const diff = e.clientX - startX;
  const newWidth = Math.max(250, Math.min(600, startWidth + diff));
  sidebar.style.width = newWidth + 'px';
});

document.addEventListener('mouseup', () => {
  if (!isResizing) return;
  isResizing = false;
  document.body.style.cursor = '';
  document.body.style.userSelect = '';
});

/**
 * Right panel open/close functionality
 */
const rightPanel = document.getElementById('right-panel');
const panelCloseBtn = document.getElementById('panel-close');
let panelToggleBtn = null;

// Make panel draggable
let isDraggingPanel = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

// Drag functionality
const panelHeader = rightPanel.querySelector('.panel-header');
panelHeader.style.cursor = 'move';
panelHeader.addEventListener('mousedown', (e) => {
  if (e.target.closest('.panel-close')) return; // Don't drag when clicking close button
  
  isDraggingPanel = true;
  
  // Calculate offset from mouse position to panel's current position
  const rect = rightPanel.getBoundingClientRect();
  dragOffsetX = e.clientX - rect.left;
  dragOffsetY = e.clientY - rect.top;
  
  document.body.style.userSelect = 'none';
  rightPanel.style.transition = 'none'; // Disable transition during drag
});

document.addEventListener('mousemove', (e) => {
  if (!isDraggingPanel) return;
  
  // Calculate new position
  let newX = e.clientX - dragOffsetX;
  let newY = e.clientY - dragOffsetY;
  
  // Constrain to viewport
  const maxX = window.innerWidth - rightPanel.offsetWidth;
  const maxY = window.innerHeight - rightPanel.offsetHeight;
  
  newX = Math.max(0, Math.min(newX, maxX));
  newY = Math.max(0, Math.min(newY, maxY));
  
  // Apply new position
  rightPanel.style.right = 'auto';
  rightPanel.style.bottom = 'auto';
  rightPanel.style.left = newX + 'px';
  rightPanel.style.top = newY + 'px';
});

document.addEventListener('mouseup', () => {
  if (!isDraggingPanel) return;
  isDraggingPanel = false;
  document.body.style.userSelect = '';
  rightPanel.style.transition = ''; // Re-enable transition
});

// Close panel
panelCloseBtn.addEventListener('click', () => {
  rightPanel.style.transform = 'translateX(420px)';
  rightPanel.style.opacity = '0';
  setTimeout(() => {
    rightPanel.style.display = 'none';
    // Create toggle button to reopen panel
    if (!panelToggleBtn) {
      panelToggleBtn = document.createElement('button');
      panelToggleBtn.id = 'panel-toggle';
      panelToggleBtn.innerHTML = 'âš™ï¸';
      panelToggleBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 12px;
        border: 2px solid rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.85));
        color: white;
        font-size: 24px;
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      `;
      panelToggleBtn.addEventListener('mouseenter', () => {
        panelToggleBtn.style.transform = 'scale(1.1)';
        panelToggleBtn.style.borderColor = 'rgba(59, 130, 246, 0.5)';
      });
      panelToggleBtn.addEventListener('mouseleave', () => {
        panelToggleBtn.style.transform = 'scale(1)';
        panelToggleBtn.style.borderColor = 'rgba(59, 130, 246, 0.3)';
      });
      panelToggleBtn.addEventListener('click', () => {
        rightPanel.style.display = 'flex';
        rightPanel.style.right = '20px';
        rightPanel.style.top = '20px';
        rightPanel.style.left = 'auto';
        rightPanel.style.bottom = '20px';
        setTimeout(() => {
          rightPanel.style.transform = 'translateX(0)';
          rightPanel.style.opacity = '1';
        }, 10);
        panelToggleBtn.remove();
        panelToggleBtn = null;
      });
      document.body.appendChild(panelToggleBtn);
    }
  }, 300);
});


// ============================================================================
// HARÄ°TA BAÅLATMA (Map Initialization)
// ============================================================================

/**
 * Leaflet haritasÄ±nÄ± oluÅŸtur
 * BaÅŸlangÄ±Ã§ gÃ¶rÃ¼nÃ¼mÃ¼: TÃ¼rkiye merkezi (39.0, 35.0) zoom 7.4
 */
const map = L.map('map', {
  zoomControl: true,
  scrollWheelZoom: true,
  doubleClickZoom: false,  // Ã‡ift tÄ±klama ile ani zoom kapalÄ±
  dragging: true,
  zoomSnap: 0.10,  // Zoom adÄ±mlarÄ±nÄ± 0.10'a dÃ¼ÅŸÃ¼rÃ¼r (Ã§ok yumuÅŸak)
  zoomDelta: 0.5,  // Butonlar iÃ§in zoom deÄŸiÅŸimi
  wheelPxPerZoomLevel: 120  // Mouse wheel hassasiyeti (yavaÅŸ zoom)
}).setView([39.0, 35.0], 7.4);

/**
 * OpenStreetMap tile layer'Ä±nÄ± ekle (Ã¼cretsiz harita katmanÄ±)
 * Tiles: https://tile.openstreetmap.org/{z}/{x}/{y}.png
 * {s}: sunucu (a,b,c), {z}: zoom, {x}/{y}: koordinatlar
 */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors',
  maxZoom: 18  // Maksimum zoom seviyesii
}).addTo(map);


// ============================================================================
// GLOBAL DEÄÄ°ÅKENLER (Global Variables)
// ============================================================================

let cityMarkers = [];           // TÃ¼rkiye ÅŸehir marker'larÄ± (10 ÅŸehir)
let detailMarkers = [];         // Ä°stanbul ilÃ§e marker'larÄ± (15 ilÃ§e)
let currentTimeframe = 'now';   // Aktif zaman dilimi: 'now', '6m', '12m'
let currentViewMode = 'markers'; // GÃ¶rselleÅŸtirme modu: 'markers' veya 'heatmap'
let heatmapLayer = null;        // Leaflet heatmap layer nesnesi
let currentData = null;         // Son yÃ¼klenen veri (tekrar render iÃ§in)
let showingDetails = false;     // Ä°stanbul detaylarÄ± gÃ¶steriliyor mu?
let satelliteLayer = null;      // Uydu gÃ¶rÃ¼ntÃ¼ katmanÄ± (NDVI/NDWI/NDBI/RGB)
let currentIndex = 'ndvi';      // Aktif index: 'ndvi', 'ndwi', 'ndbi', 'rgb'


// ============================================================================
// TÃœRKÄ°YE ÅEHÄ°RLERÄ°NÄ° YÃœKLE (Load Turkey Cities)
// ============================================================================

/**
 * TÃ¼rkiye'nin 10 bÃ¼yÃ¼k ÅŸehrini haritaya ekle
 * API: GET /api/map/turkey
 * 
 * Ä°ÅŸleyiÅŸ:
 *   1. Backend'den GeoJSON formatÄ±nda ÅŸehir verileri al
 *   2. Her ÅŸehir iÃ§in circleMarker oluÅŸtur
 *   3. Ä°stanbul yeÅŸil (aktif), diÄŸerleri gri (pasif)
 *   4. Aktif ÅŸehirlere tÄ±klanÄ±nca detay gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§
 *   5. Popup'ta ÅŸehir adÄ±, nÃ¼fus ve durum bilgisi
 */
async function loadTurkeyCities() {
  try {
    // Backend API'den ÅŸehir verilerini Ã§ek
    const response = await fetch('/api/map/turkey', {
      headers: { Authorization: `Bearer ${token}` }
    });
    
    if (!response.ok) {
      throw new Error('Åehir verileri yÃ¼klenemedi');
    }
    
    const data = await response.json();
    
    data.features.forEach(feature => {
      const props = feature.properties;
      const coords = feature.geometry.coordinates;
      
      // Create marker
      const isActive = props.active;
      const marker = L.circleMarker([coords[1], coords[0]], {
        radius: isActive ? 20 : 15,
        fillColor: isActive ? '#10b981' : '#94a3b8',
        color: 'white',
        weight: 3,
        opacity: 1,
        fillOpacity: isActive ? 0.9 : 0.5
      }).addTo(map);
      
      // Popup content
      const popupContent = `
        <div style="padding:12px;min-width:200px">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;color:#0284c7">${props.name}</div>
          <div style="font-size:13px;color:#64748b;margin-bottom:12px">
            ğŸ‘¥ NÃ¼fus: <strong>${props.population.toLocaleString()}</strong>
          </div>
          ${isActive ? 
            '<button onclick="location.href=\'/istanbul-detail.html\'" style="width:100%;padding:12px;background:linear-gradient(135deg,#0284c7,#0891b2);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px">ğŸ”¬ DetaylÄ± Analiz</button>' : 
            '<div style="text-align:center;color:#94a3b8;font-size:12px;font-weight:600">YakÄ±nda Aktif</div>'
          }
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // Click handler for active cities
      if(isActive) {
        marker.on('click', () => {
          // Show Istanbul details on map
          showIstanbulDetails();
        });
      }
      
      cityMarkers.push(marker);
    });
    
    document.getElementById('loading').style.display = 'none';
  } catch(err) {
    console.error('Error loading cities:', err);
    alert('Åehirler yÃ¼klenirken hata oluÅŸtu');
  }
}

// Show Istanbul details on map
async function showIstanbulDetails() {
  showingDetails = true;
  map.setView([41.0082, 28.9784], 11);
  
  loadMapData(currentTimeframe);
}

// Add satellite imagery layer - GerÃ§ek uydu gÃ¶rÃ¼ntÃ¼sÃ¼
function addSatelliteLayer() {
  // Eski layer'Ä± kaldÄ±r
  if(satelliteLayer) {
    map.removeLayer(satelliteLayer);
  }
  
  // Esri World Imagery - Ã¼cretsiz, gerÃ§ek uydu gÃ¶rÃ¼ntÃ¼leri
  satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
    maxZoom: 19,
    minZoom: 1
  }).addTo(map);
  
  console.log('âœ… Satellite imagery layer added');
}

// Load Istanbul district data
async function loadMapData(timeframe, animate = true) {
  try {
    const r = await fetch(`/api/map/istanbul/${timeframe}`, {
      headers: {Authorization: `Bearer ${token}`}
    });
    
    if(!r.ok) throw new Error('Failed to load map data');
    
    const data = await r.json();
    currentData = data;
    
    // Clear existing layers
    detailMarkers.forEach(m => map.removeLayer(m));
    detailMarkers = [];
    if(heatmapLayer) {
      map.removeLayer(heatmapLayer);
      heatmapLayer = null;
    }
    
    // Hide city markers when showing details
    cityMarkers.forEach(m => m.setStyle({opacity: 0.2, fillOpacity: 0.1}));
    
    // Calculate averages
    let totalGreen = 0, totalGrey = 0, totalWater = 0;
    const count = data.features.length;
    
    // Process data and calculate totals
    data.features.forEach(feature => {
      const props = feature.properties;
      totalGreen += props.green;
      totalGrey += props.grey;
      totalWater += props.water;
    });
    
    // Render based on view mode
    if(currentViewMode === 'markers') {
      renderMarkers(data, animate);
    } else {
      renderHeatmap(data);
    }
    
    // Update averages
    document.getElementById('avg-green').textContent = Math.round(totalGreen / count) + '%';
    document.getElementById('avg-grey').textContent = Math.round(totalGrey / count) + '%';
    document.getElementById('avg-water').textContent = Math.round(totalWater / count) + '%';
    
    // Hide loading
    document.getElementById('loading').style.display = 'none';
    
  } catch(err) {
    console.error('Error loading map:', err);
    alert('Harita yÃ¼klenirken hata oluÅŸtu');
  }
}

// Render markers
function renderMarkers(data, animate = true) {
  data.features.forEach((feature, index) => {
    const props = feature.properties;
    const coords = feature.geometry.coordinates;
    
    // Create custom icon based on green percentage
    const greenPercent = props.green;
    let markerColor = greenPercent > 40 ? '#10b981' : greenPercent > 25 ? '#f59e0b' : '#ef4444';
    
    const marker = L.circleMarker([coords[1], coords[0]], {
      radius: animate ? 0 : 15,
      fillColor: markerColor,
      color: 'white',
      weight: 3,
      opacity: animate ? 0 : 1,
      fillOpacity: animate ? 0 : 0.8
    }).addTo(map);
    
    // Animate marker appearance
    if(animate) {
      setTimeout(() => {
        marker.setStyle({
          radius: 15,
          opacity: 1,
          fillOpacity: 0.8
        });
      }, index * 50);
    }
    
    // Create popup
    const popupContent = `
      <div class="popup-title">${props.name}</div>
      <div class="popup-stats">
        <div class="popup-stat">
          <span class="popup-stat-label">ğŸŒ³ YeÅŸil Alan</span>
          <span class="popup-stat-value">${props.green}%</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">ğŸ¢ Beton</span>
          <span class="popup-stat-value">${props.grey}%</span>
        </div>
        <div class="popup-stat">
          <span class="popup-stat-label">ğŸ’§ Su</span>
          <span class="popup-stat-value">${props.water}%</span>
        </div>
      </div>
    `;
    
    marker.bindPopup(popupContent);
    detailMarkers.push(marker);
  });
}

// Render heatmap
function renderHeatmap(data) {
  const heatData = [];
  
  data.features.forEach(feature => {
    const props = feature.properties;
    const coords = feature.geometry.coordinates;
    
    // Use inverse of green (more grey = more heat)
    const intensity = (100 - props.green) / 100;
    heatData.push([coords[1], coords[0], intensity]);
  });
  
  heatmapLayer = L.heatLayer(heatData, {
    radius: 50,
    blur: 40,
    maxZoom: 11,
    max: 1.0,
    gradient: {
      0.0: '#10b981',
      0.3: '#22c55e',
      0.5: '#f59e0b',
      0.7: '#ef4444',
      1.0: '#dc2626'
    }
  }).addTo(map);
}

// View mode buttons (marker/heatmap)
document.querySelectorAll('.view-btn[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    // Update active state
    document.querySelectorAll('.view-btn[data-mode]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // Update mode and reload
    currentViewMode = btn.dataset.mode;
    if(currentData) {
      // Clear current view
      detailMarkers.forEach(m => map.removeLayer(m));
      detailMarkers = [];
      if(heatmapLayer) {
        map.removeLayer(heatmapLayer);
        heatmapLayer = null;
      }
      
      // Render new view
      if(currentViewMode === 'markers') {
        renderMarkers(currentData, true);
      } else {
        renderHeatmap(currentData);
      }
    }
  });
});

// Satellite toggle button
let satelliteEnabled = false;
const satelliteToggle = document.getElementById('satellite-toggle');

satelliteToggle.addEventListener('click', () => {
  satelliteEnabled = !satelliteEnabled;
  
  if (satelliteEnabled) {
    satelliteToggle.innerHTML = '<span>ï¿½ï¸ Uydu GÃ¶rÃ¼nÃ¼mÃ¼ (AÃ§Ä±k)</span>';
    satelliteToggle.classList.add('active');
    
    // Uydu katmanÄ±nÄ± ekle (sadece Ä°stanbul detaylarÄ±ndaysa)
    addSatelliteLayer();
  } else {
    satelliteToggle.innerHTML = '<span>ï¿½ï¸ Normal Harita</span>';
    satelliteToggle.classList.remove('active');
    
    // Uydu katmanÄ±nÄ± kaldÄ±r
    if (satelliteLayer) {
      map.removeLayer(satelliteLayer);
      satelliteLayer = null;
    }
  }
});

// Timeframe buttons
document.querySelectorAll('.timeframe-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Update active state
    document.querySelectorAll('.timeframe-btn').forEach(b => {
      b.classList.remove('active');
      b.querySelector('.icon').textContent = '';
    });
    btn.classList.add('active');
    btn.querySelector('.icon').textContent = 'âœ“';
    
    // Load new data
    currentTimeframe = btn.dataset.time;
    
    // Veriyi yeniden yÃ¼kle
    if(showingDetails) {
      loadMapData(currentTimeframe);
    }
  });
});

// Back to Turkey button
const backControl = L.control({position: 'topleft'});
backControl.onAdd = function() {
  const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
  div.innerHTML = '<button id="back-to-turkey" style="display:none;padding:12px 20px;background:white;border:none;color:#0284c7;border-radius:8px;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.15)">â† TÃ¼rkiye HaritasÄ±</button>';
  return div;
};
backControl.addTo(map);

document.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'back-to-turkey') {
    showingDetails = false;
    map.setView([39.0, 35.0], 6.2);
    
    // Clear all layers
    detailMarkers.forEach(m => map.removeLayer(m));
    detailMarkers = [];
    if(heatmapLayer) {
      map.removeLayer(heatmapLayer);
      heatmapLayer = null;
    }
    if(satelliteLayer) {
      map.removeLayer(satelliteLayer);
      satelliteLayer = null;
    }
    
    // Show city markers again
    cityMarkers.forEach(m => m.setStyle({opacity: 1, fillOpacity: m.options.fillColor === '#10b981' ? 0.9 : 0.5}));
    document.getElementById('back-to-turkey').style.display = 'none';
    
    // Reset info panel
    document.getElementById('avg-green').textContent = '-';
    document.getElementById('avg-grey').textContent = '-';
    document.getElementById('avg-water').textContent = '-';
  }
});

// Update showIstanbulDetails to show back button
const originalShowDetails = showIstanbulDetails;
showIstanbulDetails = async function() {
  await originalShowDetails();
  document.getElementById('back-to-turkey').style.display = 'block';
};

// Initial load - show Turkey cities
loadTurkeyCities();
</script>
</body>
</html>
